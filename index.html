<!DOCTYPE html>
<html>
<head>
    <title>War Castle: Arena PVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #game-container { width: 100vw; height: 100vh; overflow-y: auto; overflow-x: hidden; position: relative; scrollbar-width: none; display: none; }
        #game-container::-webkit-scrollbar { display: none; }
        canvas { display: block; background: #355e3b; width: 100%; height: auto; }

        /* –ú–ï–ù–Æ –ò –ü–û–ò–°–ö –ë–û–Ø */
        #menu-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #1a1a1a 0%, #000 100%); 
            z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .menu-card { background: rgba(255,255,255,0.05); padding: 40px; border-radius: 20px; border: 1px solid #444; text-align: center; backdrop-filter: blur(10px); }
        .btn-battle { 
            background: linear-gradient(to bottom, #ff00ff, #800080); border: none; color: white; 
            padding: 15px 50px; font-size: 24px; font-weight: bold; border-radius: 50px; 
            cursor: pointer; box-shadow: 0 0 20px rgba(255,0,255,0.4); transition: 0.3s;
        }
        .btn-battle:active { transform: scale(0.9); }
        .searching-text { color: #00ffff; margin-top: 20px; display: none; font-style: italic; animation: blink 1s infinite; }
        
        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }

        /* –ò–ù–¢–ï–†–§–ï–ô–° –ò–ì–†–´ */
        #ui { position: fixed; bottom: 10px; left: 0; width: 100%; display: none; justify-content: center; gap: 6px; z-index: 10; }
        .shop-item { 
            background: rgba(30, 30, 30, 0.95); border: 2px solid #4444ff; 
            width: 55px; height: 65px; text-align: center; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .stats { position: fixed; top: 5px; width: 100%; display: none; justify-content: space-between; padding: 0 10px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .stat-card { background: rgba(0,0,0,0.7); padding: 6px 12px; border-radius: 8px; font-size: 11px; border-left: 4px solid #4444ff; backdrop-filter: blur(4px); }
        .red-side { border-left: 0; border-right: 4px solid #ff4444; text-align: right; }
        
        #drag-icon { position: fixed; width: 35px; height: 35px; background: rgba(0,0,255,0.3); border: 2px solid #fff; display: none; pointer-events: none; transform: translate(-50%, -50%); z-index: 100; text-align: center; line-height: 35px; border-radius: 50%; }
        #range-preview { position: fixed; border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%; pointer-events: none; display: none; z-index: 99; transform: translate(-50%, -50%); }
    </style>
</head>
<body>

<div id="menu-screen">
    <div class="menu-card">
        <h1 style="color: #fff; margin-bottom: 5px;">WAR CASTLE</h1>
        <p style="color: #888; margin-bottom: 30px;">Online Multiplayer PVP</p>
        <button class="btn-battle" onclick="findMatch()">–í –ë–û–ô</button>
        <div id="search-status" class="searching-text">–ü–û–ò–°–ö –î–û–°–¢–û–ô–ù–û–ì–û –°–û–ü–ï–†–ù–ò–ö–ê...</div>
        <p id="online-count" style="color: #444; font-size: 12px; margin-top: 15px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...</p>
    </div>
</div>

<div class="stats" id="stats-ui">
    <div class="stat-card">
        üí∞<span id="gold1">0</span> | üè∞ <span id="hp1">500</span><br>
        üíé <span id="mines1">0</span> | ‚öîÔ∏è <span id="bld1">0</span>
    </div>
    <div class="stat-card red-side">
        üè∞ <span id="hp2">500</span> | üí∞<span id="gold2">0</span><br>
        <span id="bld2">0</span> ‚öîÔ∏è | <span id="mines2">0</span> üíé
    </div>
</div>

<div id="ui">
    <div class="shop-item" ontouchstart="startDrag('barracks', 50)">üè† 50</div>
    <div class="shop-item" ontouchstart="startDrag('archers', 150)">üèπ 150</div>
    <div class="shop-item" ontouchstart="startDrag('wall', 200)">üß± 200</div>
    <div class="shop-item" ontouchstart="startDrag('turret', 70)">üõ°Ô∏è 70</div>
    <div class="shop-item" ontouchstart="startDrag('bomb', 200)">üí£ 200</div>
    <div class="shop-item" ontouchstart="startDrag('mine', 100)">üíé <span id="mine-cost-ui">100</span></div>
</div>

<div id="drag-icon"></div>
<div id="range-preview"></div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
</div>

<script>
const socket = io("https://war-castle.onrender.com");
let gameStarted = false;
let isSearching = false;

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const container = document.getElementById("game-container");
const dragIcon = document.getElementById("drag-icon");

let gameState = {
    p1: { gold: 100, hp: 500, income: 3, mines: 0, combatBuildings: 0 }, 
    p2: { gold: 100, hp: 500, income: 3, mines: 0, combatBuildings: 0 }, 
    units: [], buildings: [], projectiles: [], vfx: []
};

// --- –°–ï–¢–ï–í–ê–Ø –õ–û–ì–ò–ö–ê ---

socket.on('playerUpdate', (count) => {
    document.getElementById('online-count').innerText = `–ò–ì–†–û–ö–û–í –í –°–ï–¢–ò: ${count}`;
});

function findMatch() {
    if (isSearching) return;
    isSearching = true;
    document.getElementById('search-status').style.display = 'block';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä—É —Å–∏–≥–Ω–∞–ª, —á—Ç–æ –º—ã –≥–æ—Ç–æ–≤—ã
    socket.emit('findMatch'); 
}

// –ö–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –Ω–∞—à–µ–ª –¥–≤–æ–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
socket.on('matchFound', () => {
    startPVPGame();
});

function startPVPGame() {
    gameStarted = true;
    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('ui').style.display = 'flex';
    document.getElementById('stats-ui').style.display = 'flex';
    container.style.display = 'block';
    resize();
    setTimeout(() => container.scrollTop = canvas.height, 200);
    update();
}

// –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –î–ï–ù–ï–ì (–ü—Ä–∏–Ω–∏–º–∞–µ–º –æ—Ç –≤—Ä–∞–≥–∞)
socket.on('syncEnemyResources', (data) => {
    gameState.p2.gold = data.gold;
    gameState.p2.mines = data.mines;
    gameState.p2.combatBuildings = data.combatBuildings;
});

// –ü–†–ò–ï–ú –ó–î–ê–ù–ò–ô (–ó–ï–†–ö–ê–õ–¨–ù–û)
socket.on('enemySpawn', (data) => {
    let mirroredX = canvas.width - data.x - (data.type === 'wall' ? 80 : 40);
    let mirroredY = canvas.height - data.y - 40;
    let hp = (data.type === 'wall') ? 1200 : 450;
    gameState.buildings.push({ type: data.type, player: 2, x: mirroredX, y: mirroredY, hp: hp, maxHp: hp, lastSpawn: Date.now(), lastShot: 0 });
});

// --- –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ---

let dragging = null;
function startDrag(type, cost) {
    let actualCost = type === 'mine' ? 100 + (gameState.p1.mines * 100) : cost;
    if (gameState.p1.gold >= actualCost && (type !== 'mine' || gameState.p1.mines < 3)) {
        dragging = { type, cost: actualCost };
        dragIcon.style.display = "block";
        dragIcon.innerHTML = type === 'barracks' ? "üè†" : (type === 'mine' ? "üíé" : "üõ°Ô∏è");
    }
}

window.addEventListener('touchmove', (e) => {
    if (dragging) {
        dragIcon.style.left = e.touches[0].clientX + "px";
        dragIcon.style.top = e.touches[0].clientY + "px";
    }
});

window.addEventListener('touchend', (e) => {
    if (!dragging) return;
    let touch = e.changedTouches[0], cY = touch.clientY + container.scrollTop, cX = touch.clientX;
    let w = dragging.type === 'wall' ? 80 : 40;

    if (cY > canvas.height / 2 && cY < canvas.height - 70) {
        gameState.p1.gold -= dragging.cost;
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        socket.emit('spawnUnit', { type: dragging.type, x: cX - w/2, y: cY - 20 });
        
        if (dragging.type === 'mine') { gameState.p1.income += 4; gameState.p1.mines++; }
        else { gameState.p1.combatBuildings++; }
        
        let hp = (dragging.type === 'wall') ? 1200 : 450;
        gameState.buildings.push({ type: dragging.type, player: 1, x: cX - w/2, y: cY - 20, hp: hp, maxHp: hp, lastSpawn: Date.now(), lastShot: 0 });
    }
    dragging = null; dragIcon.style.display = "none";
});

function update() {
    if(!gameStarted) return;

    // –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–• –î–õ–Ø –í–†–ê–ì–ê (—Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)
    if (Math.floor(Date.now() / 1000) % 1 === 0) {
        socket.emit('syncResources', {
            gold: gameState.p1.gold,
            mines: gameState.p1.mines,
            combatBuildings: gameState.p1.combatBuildings
        });
    }

    gameState.p1.gold += gameState.p1.income / 60;
    
    // UI
    document.getElementById("gold1").innerText = Math.floor(gameState.p1.gold);
    document.getElementById("gold2").innerText = Math.floor(gameState.p2.gold);
    document.getElementById("hp1").innerText = Math.floor(gameState.p1.hp);
    document.getElementById("hp2").innerText = Math.floor(gameState.p2.hp);
    document.getElementById("mines1").innerText = gameState.p1.mines;
    document.getElementById("mines2").innerText = gameState.p2.mines;

    // –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–µ–ª—å–±—ã, —Ö–æ–¥—å–±—ã –∏ —É—Ä–æ–Ω–∞ (—Ç–∞ –∂–µ, —á—Ç–æ –±—ã–ª–∞ –≤ —Ç–≤–æ–µ–º –∫–æ–¥–µ)
    processUnits(); 
    
    draw();
    requestAnimationFrame(update);
}

function processUnits() {
    // –î–≤–∏–∂–µ–Ω–∏–µ —é–Ω–∏—Ç–æ–≤ (–∑–µ—Ä–∫–∞–ª—å–Ω–æ–µ)
    gameState.units.forEach((u, i) => {
        u.y += u.speed;
        if (u.y < 50 && u.player === 1) { gameState.p2.hp -= 50; u.hp = 0; }
        if (u.y > canvas.height - 50 && u.player === 2) { gameState.p1.hp -= 50; u.hp = 0; }
        if (u.hp <= 0) gameState.units.splice(i, 1);
    });

    // –°–ø–∞–≤–Ω –∏–∑ –∫–∞–∑–∞—Ä–º
    gameState.buildings.forEach(b => {
        if ((b.type === 'barracks' || b.type === 'archers') && Date.now() - b.lastSpawn > 6000) {
            gameState.units.push({ player: b.player, x: b.x + 20, y: b.y + 20, hp: 100, maxHp: 100, speed: b.player === 1 ? -0.8 : 0.8 });
            b.lastSpawn = Date.now();
        }
    });
}

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight * 2.5; }
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#355e3b"; ctx.fillRect(0,0, canvas.width, canvas.height);
    // –õ–∏–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞
    ctx.fillStyle = "rgba(255,255,255,0.1)"; ctx.fillRect(0, canvas.height/2 - 2, canvas.width, 4);
    
    gameState.buildings.forEach(b => {
        ctx.fillStyle = b.player === 1 ? "#3b44cc" : "#cc3b3b";
        ctx.fillRect(b.x, b.y, b.type === 'wall' ? 80 : 40, 40);
        ctx.fillStyle = "white"; ctx.fillRect(b.x, b.y - 10, (b.hp/b.maxHp)*40, 5);
    });

    gameState.units.forEach(u => {
        ctx.fillStyle = u.player === 1 ? "#4444ff" : "#ff4444";
        ctx.beginPath(); ctx.arc(u.x, u.y, 14, 0, Math.PI*2); ctx.fill();
    });
}
</script>
</body>
</html>
