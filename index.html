<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>War Castle Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        
        /* –°—Ç–∞—Ç—É—Å —Å–µ—Ç–∏ */
        #net { position: fixed; top: 10px; right: 10px; display: flex; align-items: center; gap: 8px; z-index: 1000; padding: 5px 10px; background: rgba(0,0,0,0.7); border-radius: 20px; border: 1px solid #444; }
        #dot { width: 10px; height: 10px; background: red; border-radius: 50%; transition: 0.3s; }
        .online { background: #00ff00 !important; box-shadow: 0 0 10px #00ff00; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #lobby { position: fixed; inset: 0; background: #111; z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #game-ui { display: none; position: fixed; width: 100%; height: 100%; pointer-events: none; }
        .stats { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; font-size: 20px; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        
        #shop { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 10px; pointer-events: auto; }
        .item { background: #222; border: 2px solid #4444ff; padding: 10px; border-radius: 10px; width: 60px; text-align: center; cursor: pointer; }
        .item.active { border-color: #00ff00; background: #333; }

        canvas { display: block; background: #325d2d; }
        button { padding: 15px 40px; font-size: 20px; background: #4444ff; color: white; border: none; border-radius: 10px; cursor: pointer; }
        button:disabled { opacity: 0.5; }
    </style>
</head>
<body>

<div id="net">
    <span id="net-text">CONNECTING</span>
    <div id="dot"></div>
</div>

<div id="lobby">
    <h1 style="color:#4444ff">WAR CASTLE</h1>
    <div id="counter" style="margin: 20px; color:#0f0; font-size: 24px;">–û–∂–∏–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞...</div>
    <button id="find-btn" onclick="startSearch()">–í –ë–û–ô!</button>
</div>

<div id="game-ui">
    <div class="stats">
        <div style="color: gold;">üí∞ <span id="gold">100</span></div>
        <div style="color: #f44;">‚ù§ HP: <span id="hp">1000</span></div>
    </div>
    <div id="shop">
        <div class="item" id="btn-barracks" onclick="select('barracks', 50)">üè†<br>50</div>
        <div class="item" id="btn-mine" onclick="select('mine', 100)">üíé<br>100</div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // –ü–†–Ø–ú–û–ô –ê–î–†–ï–° –¢–í–û–ï–ì–û –°–ï–†–í–ï–†–ê
    const socket = io("https://war-castle-v2.onrender.com", {
        transports: ["polling", "websocket"]
    });

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    let role, room, gold = 100, hp = 1000, mines = 0, selected = null, cost = 0;
    let state = { buildings: [], units: [] };

    // --- –°–ï–¢–¨ ---
    socket.on('connect', () => {
        document.getElementById('dot').classList.add('online');
        document.getElementById('net-text').innerText = "ONLINE";
    });

    socket.on('onlineUpdate', (c) => {
        document.getElementById('counter').innerText = `–ò–ì–†–û–ö–û–í –í –°–ï–¢–ò: ${c}`;
    });

    function startSearch() {
        socket.emit('findGame');
        document.getElementById('find-btn').innerText = "–ü–û–ò–°–ö...";
        document.getElementById('find-btn').disabled = true;
    }

    socket.on('startGame', (d) => {
        role = d.role; room = d.room;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        requestAnimationFrame(loop);
    });

    socket.on('syncBuilding', (d) => {
        addBuilding(d.type, d.role, canvas.width - d.x, canvas.height - d.y);
    });

    // --- –ò–ì–†–ê ---
    function select(type, c) {
        selected = type; cost = c;
        document.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
        document.getElementById('btn-' + type).classList.add('active');
    }

    canvas.onclick = (e) => {
        if (!selected || gold < cost || e.clientY < canvas.height / 2 + 50) return;
        gold -= cost;
        addBuilding(selected, role, e.clientX, e.clientY);
        socket.emit('placeBuilding', { type: selected, x: e.clientX, y: e.clientY, role, room });
        selected = null;
        document.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
    };

    function addBuilding(type, bRole, x, y) {
        state.buildings.push({ type, role: bRole, x, y, last: Date.now() });
        if (bRole === role && type === 'mine') mines++;
    }

    function loop() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        ctx.strokeStyle = "rgba(255,255,255,0.2)";
        ctx.strokeRect(0, canvas.height/2, canvas.width, 1);

        gold += (1.5 + mines * 2) / 60;
        document.getElementById('gold').innerText = Math.floor(gold);

        state.buildings.forEach(b => {
            ctx.fillStyle = b.role === role ? "#44f" : "#f44";
            ctx.fillRect(b.x-20, b.y-20, 40, 40);
            if (b.type === 'barracks' && Date.now() - b.last > 4000) {
                state.units.push({ x: b.x, y: b.y, role: b.role, s: b.role === role ? -2 : 2 });
                b.last = Date.now();
            }
        });

        state.units.forEach((u, i) => {
            u.y += u.s;
            ctx.fillStyle = u.role === role ? "#0ff" : "#fa0";
            ctx.beginPath(); ctx.arc(u.x, u.y, 7, 0, Math.PI*2); ctx.fill();
            if (u.y < 0 || u.y > canvas.height) {
                if (u.role === role) {
                    hp -= 50;
                    document.getElementById('hp').innerText = hp;
                }
                state.units.splice(i, 1);
                if (hp <= 0) { alert("–ö–û–ù–ï–¶ –ò–ì–†–´"); location.reload(); }
            }
        });
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>
