<!DOCTYPE html>
<html>
<head>
    <title>War Castle Multiplayer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #lobby { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #game-container { width: 100vw; height: 100vh; overflow: hidden; position: relative; display: none; }
        canvas { display: block; background: #355e3b; }
        
        #ui { position: fixed; bottom: 10px; left: 0; width: 100%; display: flex; justify-content: center; gap: 6px; z-index: 10; display: none; }
        .shop-item { background: rgba(30,30,30,0.95); border: 2px solid #4444ff; width: 55px; height: 65px; text-align: center; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .stats { position: fixed; top: 5px; width: 100%; display: flex; justify-content: space-between; padding: 0 10px; box-sizing: border-box; z-index: 10; pointer-events: none; display: none; }
        .stat-card { background: rgba(0,0,0,0.7); padding: 6px 12px; border-radius: 8px; font-size: 11px; border-left: 4px solid #4444ff; }
        
        #status-text { margin-bottom: 20px; font-size: 1.2em; color: #ff00ff; text-align: center; }
        #online-counter { margin-top: 10px; color: #00ff00; font-size: 0.9em; }
        button { padding: 15px 30px; font-size: 18px; background: #4444ff; color: white; border: none; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        button:disabled { background: #444; color: #888; }
    </style>
</head>
<body>

<div id="lobby">
    <div id="status-text">War Castle: Walls Tactical</div>
    <button id="find-btn" onclick="startSearch()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø –ö –°–ï–†–í–ï–†–£</button>
    <div id="online-counter">–ò–≥—Ä–æ–∫–æ–≤ –≤ —Å–µ—Ç–∏: ...</div>
</div>

<div class="stats" id="game-stats">
    <div class="stat-card">üí∞<span id="gold1">0</span> | üè∞ <span id="hp1">500</span></div>
    <div class="stat-card" style="border-left:0; border-right:4px solid red; text-align:right;">üè∞ <span id="hp2">500</span> | üí∞<span id="gold2">0</span></div>
</div>

<div id="ui">
    <div class="shop-item" ontouchstart="startDrag('barracks', 50)">üè†<div style="color:gold; font-size:10px">50</div></div>
    <div class="shop-item" ontouchstart="startDrag('archers', 150)">üèπ<div style="color:gold; font-size:10px">150</div></div>
    <div class="shop-item" ontouchstart="startDrag('wall', 200)">üß±<div style="color:gold; font-size:10px">200</div></div>
    <div class="shop-item" ontouchstart="startDrag('turret', 70)">üõ°Ô∏è<div style="color:gold; font-size:10px">70</div></div>
    <div class="shop-item" ontouchstart="startDrag('mine', 100)">üíé<div id="mine-cost-ui" style="color:gold; font-size:10px">100</div></div>
</div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let socket;
let playerRole = null; 
let currentRoom = null;
let isSearching = false;

let gameState = {
    p1: { gold: 100, hp: 500, mines: 0 },
    p2: { gold: 100, hp: 500, mines: 0 },
    units: [], buildings: []
};

// --- –°–ï–¢–ï–í–ê–Ø –õ–û–ì–ò–ö–ê ---
function startSearch() {
    if (isSearching) return;
    isSearching = true;
    document.getElementById('find-btn').disabled = true;
    document.getElementById('status-text').innerText = "–ü–æ–∏—Å–∫ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...";

    // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL –æ—Ç Render (–Ω–∞–ø—Ä–∏–º–µ—Ä https://war-castle.onrender.com)
    socket = io("https://your-app-name.onrender.com"); 

    socket.on('onlineUpdate', (count) => {
        document.getElementById('online-counter').innerText = `–ò–≥—Ä–æ–∫–æ–≤ –≤ —Å–µ—Ç–∏: ${count}`;
    });

    socket.emit('findGame');

    socket.on('startGame', (data) => {
        playerRole = data.role;
        currentRoom = data.room;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('ui').style.display = 'flex';
        document.getElementById('game-stats').style.display = 'flex';
        
        initGame();
    });

    socket.on('syncBuilding', (data) => {
        // –ó–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤—Ä–∞–≥–∞
        let realX = canvas.width - data.x - (data.type === 'wall' ? 80 : 40);
        let realY = canvas.height - data.y - (data.type === 'wall' ? 15 : 40);
        addBuilding(data.type, data.role, realX, realY);
    });
}

function initGame() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    update();
}

// --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
let dragging = null;
function startDrag(type, cost) {
    let p = playerRole === 1 ? gameState.p1 : gameState.p2;
    let actualCost = type === 'mine' ? 100 + (p.mines * 100) : cost;
    if (p.gold >= actualCost) {
        dragging = { type, cost: actualCost };
    }
}

window.addEventListener('touchend', (e) => {
    if (!dragging || !playerRole) return;
    let touch = e.changedTouches[0];
    let x = touch.clientX;
    let y = touch.clientY;

    // –ò–≥—Ä–æ–∫ 1 —Å—Ç—Ä–æ–∏—Ç —Å–Ω–∏–∑—É (y > half), –ò–≥—Ä–æ–∫ 2 —Ç–æ–∂–µ –≤–∏–¥–∏—Ç —Å–µ–±—è —Å–Ω–∏–∑—É
    if (y > canvas.height / 2 + 50) {
        let p = playerRole === 1 ? gameState.p1 : gameState.p2;
        p.gold -= dragging.cost;
        
        addBuilding(dragging.type, playerRole, x, y);

        socket.emit('placeBuilding', {
            type: dragging.type,
            x: x, 
            y: y,
            role: playerRole,
            room: currentRoom
        });
    }
    dragging = null;
});

function addBuilding(type, player, x, y) {
    let hp = (type === 'wall') ? 900 : 400;
    gameState.buildings.push({
        type, player, x, y, hp, maxHp: hp, lastSpawn: Date.now()
    });
    if (type === 'mine') {
        if (player === 1) gameState.p1.mines++;
        else gameState.p2.mines++;
    }
}

function update() {
    // –ó–æ–ª–æ—Ç–æ
    gameState.p1.gold += (3 + gameState.p1.mines * 4) / 60;
    gameState.p2.gold += (3 + gameState.p2.mines * 4) / 60;

    document.getElementById('gold1').innerText = Math.floor(gameState.p1.gold);
    document.getElementById('gold2').innerText = Math.floor(gameState.p2.gold);

    // –Æ–Ω–∏—Ç—ã (–∞–≤—Ç–æ-—Å–ø–∞–≤–Ω –∏–∑ –∫–∞–∑–∞—Ä–º)
    gameState.buildings.forEach(b => {
        if ((b.type === 'barracks' || b.type === 'archers') && Date.now() - b.lastSpawn > 4000) {
            gameState.units.push({
                player: b.player,
                x: b.x + 20,
                y: b.y,
                speed: b.player === playerRole ? -1.2 : 1.2 
            });
            b.lastSpawn = Date.now();
        }
    });

    gameState.units.forEach((u, i) => {
        u.y += u.speed;
        if (u.y < 0 || u.y > canvas.height) gameState.units.splice(i, 1);
    });

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // –ü–æ–ª–µ
    ctx.strokeStyle = "rgba(255,255,255,0.3)";
    ctx.setLineDash([10, 10]);
    ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();
    ctx.setLineDash([]);

    gameState.buildings.forEach(b => {
        ctx.fillStyle = b.player === playerRole ? "#4444ff" : "#ff4444";
        let w = b.type === 'wall' ? 80 : 40;
        let h = b.type === 'wall' ? 15 : 40;
        ctx.fillRect(b.x - w/2, b.y - h/2, w, h);
    });

    gameState.units.forEach(u => {
        ctx.fillStyle = u.player === playerRole ? "#00ffff" : "#ffaa00";
        ctx.beginPath(); ctx.arc(u.x, u.y, 10, 0, Math.PI*2); ctx.fill();
    });
}
</script>
</body>
</html>
