<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fantasy Duel 2.0</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial', sans-serif; color: white; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        /* Интерфейс */
        .gui { position: absolute; z-index: 10; pointer-events: none; width: 100%; height: 100%; }
        .base-hp { position: absolute; width: 120px; height: 14px; background: #333; border: 2px solid #fff; border-radius: 7px; overflow: hidden; }
        .hp-fill { height: 100%; width: 100%; transition: width 0.3s; }
        #hp-blue-cont { top: 20px; left: 20px; } #hp-blue { background: #00d2ff; }
        #hp-red-cont { top: 20px; right: 20px; } #hp-red { background: #ff4757; }
        
        .mana-box { position: absolute; bottom: 30px; left: 20px; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px; border: 2px solid #00d2ff; font-weight: bold; font-size: 18px; pointer-events: auto; }
        .btn-deploy { position: absolute; bottom: 30px; right: 20px; width: 80px; height: 80px; background: #5d4037; border: 4px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; pointer-events: auto; box-shadow: 0 0 20px rgba(0,0,0,0.5); active { transform: scale(0.9); } }

        /* Оверлеи */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; padding: 20px; }
        .btn-start { padding: 15px 40px; background: #2ecc71; color: white; border: none; border-radius: 10px; font-size: 20px; margin-top: 20px; cursor: pointer; }
        .status-text { font-size: 18px; color: #aaa; margin: 10px; }
        #result-screen { display: none; }
    </style>
</head>
<body>

<div class="gui" id="game-ui" style="display: none;">
    <div id="hp-blue-cont" class="base-hp"><div id="hp-blue" class="hp-fill"></div></div>
    <div id="hp-red-cont" class="base-hp"><div id="hp-red" class="hp-fill"></div></div>
    <div class="mana-box">MANA: <span id="mana-val">0</span></div>
    <div class="btn-deploy" onclick="spawnUnit()">SEND</div>
</div>

<div id="lobby" class="overlay">
    <h1>FANTASY DUEL</h1>
    <div id="net-info" class="status-text">Подключение к серверу...</div>
    <div id="player-info" class="status-text">Ожидание роли...</div>
    <button id="start-btn" class="btn-start" onclick="startGameRequest()" style="display: none;">В БОЙ!</button>
</div>

<div id="result-screen" class="overlay">
    <h1 id="result-title">КОНЕЦ ИГРЫ</h1>
    <button class="btn-start" onclick="location.reload()">В МЕНЮ</button>
</div>

<canvas id="game"></canvas>

<script>
    const socket = io('https://megame-server.onrender.com', { transports: ['websocket'] });
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // Настройки мира
    const WORLD = { width: 600, height: 2000 }; 
    let mySide = null; // 1 - Red (top), 2 - Blue (bottom)
    let gameActive = false;
    let players = { 1: { hp: 100, mana: 500 }, 2: { hp: 100, mana: 500 } };
    let units = [];
    let cameraY = 0;

    const mapImg = new Image(); mapImg.src = 'map.jpg';
    const bazaImg = new Image(); bazaImg.src = 'baza.jpg';

    // --- СЕТЬ ---
    socket.on('connect', () => { document.getElementById('net-info').innerText = "Сервер: Онлайн"; });
    
    socket.on('playerRole', role => {
        mySide = role;
        document.getElementById('player-info').innerText = "Ты: Игрок " + (role === 1 ? "КРАСНЫЙ (Защищай верх)" : "СИНИЙ (Защищай низ)");
    });

    socket.on('playerCount', count => {
        if (count >= 2 && mySide === 2) {
            document.getElementById('start-btn').style.display = 'block';
        }
    });

    socket.on('gameStart', () => {
        gameActive = true;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        cameraY = (mySide === 1) ? -800 : 800; // Разная камера для игроков
    });

    socket.on('spawnUnit', data => { units.push(data); });

    function startGameRequest() { socket.emit('startGame'); }

    function spawnUnit() {
        if (!gameActive || players[mySide].mana < 50) return;
        players[mySide].mana -= 50;

        const unit = {
            id: Math.random(),
            side: mySide,
            x: (Math.random() * 400) - 200,
            y: (mySide === 1) ? -WORLD.height + 250 : WORLD.height - 250,
            hp: 100,
            color: (mySide === 1) ? '#ff4757' : '#00d2ff'
        };

        units.push(unit);
        socket.emit('spawnUnit', unit);
    }

    // --- ЛОГИКА ---
    function update() {
        if (!gameActive) return;

        units.forEach((u, i) => {
            let target = null;
            // Поиск врага
            units.forEach(o => {
                if (u.side !== o.side && Math.abs(u.y - o.y) < 50 && Math.abs(u.x - o.x) < 40) target = o;
            });

            if (target) {
                target.hp -= 0.6; // Битва
            } else {
                u.y += (u.side === 1) ? 3 : -3; // Движение
            }

            // Урон базе
            if (u.side === 2 && u.y < -WORLD.height + 150) { players[1].hp -= 5; u.hp = 0; }
            if (u.side === 1 && u.y > WORLD.height - 150) { players[2].hp -= 5; u.hp = 0; }
            
            if (u.hp <= 0) units.splice(i, 1);
        });

        // Мана
        players[1].mana += 0.1; players[2].mana += 0.1;
        
        // Проверка победы
        if (players[1].hp <= 0 || players[2].hp <= 0) {
            gameActive = false;
            const win = (players[1].hp <= 0 && mySide === 2) || (players[2].hp <= 0 && mySide === 1);
            document.getElementById('result-title').innerText = win ? "ПОБЕДА!" : "ПОРАЖЕНИЕ";
            document.getElementById('result-screen').style.display = 'flex';
        }

        // Обновление UI
        document.getElementById('mana-val').innerText = Math.floor(players[mySide].mana);
        document.getElementById('hp-blue').style.width = players[2].hp + '%';
        document.getElementById('hp-red').style.width = players[1].hp + '%';
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        
        // Камера и Центрирование
        ctx.translate(canvas.width/2, canvas.height/2 - cameraY);

        // Дорога
        if (mapImg.complete) {
            for (let y = -WORLD.height; y < WORLD.height; y += 400) {
                ctx.drawImage(mapImg, -WORLD.width/2, y, WORLD.width, 405);
            }
        }

        // Базы
        if (bazaImg.complete) {
            ctx.drawImage(bazaImg, -WORLD.width/2, -WORLD.height, WORLD.width, 250);
            ctx.save();
            ctx.translate(0, WORLD.height);
            ctx.rotate(Math.PI);
            ctx.drawImage(bazaImg, -WORLD.width/2, -250, WORLD.width, 250);
            ctx.restore();
        }

        // Юниты
        units.forEach(u => {
            ctx.fillStyle = u.color;
            ctx.beginPath(); ctx.arc(u.x, u.y, 18, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.stroke();
            // ХП
            ctx.fillStyle = "red"; ctx.fillRect(u.x - 20, u.y - 35, 40, 5);
            ctx.fillStyle = "lime"; ctx.fillRect(u.x - 20, u.y - 35, 40 * (u.hp/100), 5);
        });

        ctx.restore();
        if (gameActive) update();
        requestAnimationFrame(draw);
    }

    // --- УПРАВЛЕНИЕ ---
    let isDrag = false, startY = 0;
    const handleStart = (y) => { isDrag = true; startY = y + cameraY; };
    const handleMove = (y) => { if (isDrag) cameraY = startY - y; };

    canvas.onmousedown = e => handleStart(e.clientY);
    window.onmousemove = e => handleMove(e.clientY);
    window.onmouseup = () => isDrag = false;

    canvas.ontouchstart = e => handleStart(e.touches[0].clientY);
    canvas.ontouchmove = e => { handleMove(e.touches[0].clientY); e.preventDefault(); };
    canvas.ontouchend = () => isDrag = false;

    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    draw();
</script>
</body>
</html>
