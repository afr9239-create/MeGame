<!DOCTYPE html>
<html>
<head>
    <title>War Castle: Walls Tactical Update</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; 
            background: #1a1a1a; 
            color: white; 
            font-family: sans-serif; 
            overflow: hidden; 
            touch-action: pan-y; /* –†–∞–∑—Ä–µ—à–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
        }
        #game-container { 
            width: 100vw; 
            height: 100vh; 
            overflow-y: auto; 
            overflow-x: hidden; 
            position: relative; 
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–∞ iOS */
        }
        #game-container::-webkit-scrollbar { display: none; }
        
        canvas { 
            display: block; 
            width: 100%;
            height: auto;
            background: #355e3b; 
            touch-action: pan-y; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –Ω–∞ canvas */
        }

        #ui { 
            position: fixed; 
            bottom: 10px; 
            left: 0; 
            width: 100%; 
            display: flex; 
            justify-content: center; 
            gap: 6px; 
            z-index: 10; 
            flex-wrap: wrap; /* –ö–Ω–æ–ø–∫–∏ –º–æ–≥—É—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è */
            padding: 0 5px;
            box-sizing: border-box;
            pointer-events: none; /* –ü–æ–∑–≤–æ–ª—è–µ—Ç –∫–ª–∏–∫–∞—Ç—å —Å–∫–≤–æ–∑—å –ø—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞ */
        }
        .shop-item { 
            background: rgba(30, 30, 30, 0.95); 
            border: 2px solid #4444ff; 
            width: 55px; 
            height: 65px; 
            text-align: center; 
            border-radius: 8px;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            transition: 0.2s;
            pointer-events: auto; /* –ö–Ω–æ–ø–∫–∏ –º–æ–∂–Ω–æ –Ω–∞–∂–∏–º–∞—Ç—å */
            cursor: pointer;
            user-select: none;
        }
        .shop-item.active { 
            border-color: #ff00ff; 
            background: rgba(80, 0, 80, 0.8); 
            transform: scale(1.1); 
        }
        .item-icon { font-size: 24px; }
        .item-cost { color: #ffd700; font-weight: bold; font-size: 11px; margin-top: 2px; }

        .stats { 
            position: fixed; 
            top: 10px; 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            padding: 0 10px; 
            box-sizing: border-box; 
            z-index: 10; 
            pointer-events: none;
        }
        .stat-card { 
            background: rgba(0,0,0,0.8); 
            padding: 8px 15px; 
            border-radius: 10px; 
            font-size: 14px; 
            border-left: 4px solid #4444ff; 
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .red-side { 
            border-left: 0; 
            border-right: 4px solid #ff4444; 
            text-align: right; 
        }

        #drag-icon { 
            position: fixed; 
            width: 40px; 
            height: 40px; 
            background: rgba(0,0,255,0.5); 
            border: 2px solid #fff; 
            border-radius: 5px;
            display: none; 
            pointer-events: none; 
            transform: translate(-50%, -50%); 
            z-index: 100; 
            font-size: 24px; 
            text-align: center; 
            line-height: 40px; 
            box-shadow: 0 0 10px rgba(0,0,255,0.5);
        }
        #drag-icon.wall-drag { 
            width: 90px; 
            height: 20px; 
            line-height: 20px;
            background: rgba(0,0,255,0.6);
        }
        
        /* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
        .scroll-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            z-index: 1000;
            animation: fadeOut 3s forwards;
            pointer-events: none;
            white-space: nowrap;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>

<div class="stats">
    <div class="stat-card">
        üí∞<span id="gold1">100</span> | üè∞ <span id="hp1">500</span><br>
        üíé <span id="mines1">0</span>/3 | ‚öîÔ∏è <span id="bld1">0</span>/25
    </div>
    <div class="stat-card red-side">
        üè∞ <span id="hp2">500</span> | üí∞<span id="gold2">100</span><br>
        25/<span id="bld2">0</span> ‚öîÔ∏è | 3/<span id="mines2">0</span> üíé
    </div>
</div>

<div id="ui">
    <div class="shop-item" onclick="startDrag('barracks', 50)">
        <div class="item-icon">üè†</div>
        <div class="item-cost">50</div>
    </div>
    <div class="shop-item" onclick="startDrag('archers', 150)">
        <div class="item-icon">üèπ</div>
        <div class="item-cost">150</div>
    </div>
    <div class="shop-item" onclick="startDrag('wall', 200)">
        <div class="item-icon">üß±</div>
        <div class="item-cost">200</div>
    </div>
    <div class="shop-item" onclick="startDrag('turret', 70)">
        <div class="item-icon">üõ°Ô∏è</div>
        <div class="item-cost">70</div>
    </div>
    <div class="shop-item" onclick="startDrag('bomb', 200)">
        <div class="item-icon">üí£</div>
        <div class="item-cost">200</div>
    </div>
    <div class="shop-item" onclick="startDrag('mine', 100)">
        <div class="item-icon">üíé</div>
        <div class="item-cost" id="mine-cost-ui">100</div>
    </div>
    <div class="shop-item" onclick="toggleSellMode()" id="sell-btn">
        <div class="item-icon">üí∞‚úñÔ∏è</div>
        <div class="item-cost">Sell</div>
    </div>
</div>

<div id="drag-icon"></div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
</div>

<script>
(function() {
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const dragIcon = document.getElementById("drag-icon");
    const container = document.getElementById("game-container");

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
    const hint = document.createElement('div');
    hint.className = 'scroll-hint';
    hint.textContent = 'üëÜ –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–Ω–∏–∑, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–ª–µ –±–∏—Ç–≤—ã';
    document.body.appendChild(hint);
    setTimeout(() => hint.remove(), 3000);

    let sellMode = false;
    let gameState = {
        p1: { gold: 100, hp: 500, income: 3, mines: 0, bombs: 0, combatBuildings: 0, barracks: 0, archerHouses: 0, turrets: 0 }, 
        p2: { gold: 100, hp: 500, income: 3, mines: 0, bombs: 0, combatBuildings: 0, barracks: 0, archerHouses: 0, turrets: 0 }, 
        units: [], 
        buildings: [], 
        projectiles: [], 
        vfx: []
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –∑–¥–∞–Ω–∏—è–º–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
    function initTestBuildings() {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–¥–∞–Ω–∏–π –¥–ª—è —Å–∏–Ω–µ–≥–æ –∏–≥—Ä–æ–∫–∞ (–∏–≥—Ä–æ–∫)
        gameState.buildings.push({ 
            type: 'barracks', 
            player: 1, 
            x: 100, 
            y: 400, 
            hp: 350, 
            maxHp: 350, 
            lastSpawn: Date.now(), 
            lastShot: 0 
        });
        gameState.buildings.push({ 
            type: 'turret', 
            player: 1, 
            x: 200, 
            y: 300, 
            hp: 550, 
            maxHp: 550, 
            lastSpawn: 0, 
            lastShot: 0 
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–¥–∞–Ω–∏–π –¥–ª—è –∫—Ä–∞—Å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (–ò–ò)
        gameState.buildings.push({ 
            type: 'barracks', 
            player: 2, 
            x: 500, 
            y: 800, 
            hp: 350, 
            maxHp: 350, 
            lastSpawn: Date.now(), 
            lastShot: 0 
        });
        gameState.buildings.push({ 
            type: 'wall', 
            player: 2, 
            x: 450, 
            y: 700, 
            hp: 900, 
            maxHp: 900, 
            lastSpawn: 0, 
            lastShot: 0 
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö —é–Ω–∏—Ç–æ–≤
        gameState.units.push({ 
            player: 1, 
            type: 'knight', 
            x: 300, 
            y: 500, 
            hp: 100, 
            maxHp: 100, 
            speed: -0.8, 
            lastShot: 0 
        });
        gameState.units.push({ 
            player: 2, 
            type: 'archer', 
            x: 600, 
            y: 600, 
            hp: 50, 
            maxHp: 50, 
            speed: 0.8, 
            lastShot: 0 
        });
    }

    function toggleSellMode() {
        sellMode = !sellMode;
        document.getElementById('sell-btn').classList.toggle('active', sellMode);
    }

    function destroyBuilding(index) {
        let b = gameState.buildings[index];
        if (!b) return;
        let p = b.player === 1 ? gameState.p1 : gameState.p2;
        if (b.type === 'mine') { 
            p.income -= 4; 
            p.mines--; 
        } else { 
            if (b.type === 'bomb') p.bombs--; 
            else if (b.type === 'barracks') p.barracks--;
            else if (b.type === 'archers') p.archerHouses--;
            else if (b.type !== 'wall') p.turrets--;
            p.combatBuildings--; 
        }
        gameState.buildings.splice(index, 1);
    }

    const decorations = [];
    function initDecorations() {
        for(let i = 0; i < 60; i++) {
            decorations.push({ 
                x: Math.random() * 800, 
                y: Math.random() * 2000, 
                size: 2 + Math.random() * 8, 
                type: Math.random() > 0.5 ? 'stone' : 'grass' 
            });
        }
    }

    function resize() { 
        canvas.width = window.innerWidth; 
        canvas.height = 2000; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        
        if(decorations.length === 0) initDecorations(); 
    }
    
    window.addEventListener('resize', resize); 
    resize();
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ –ø–æ–ª–µ
    setTimeout(() => {
        container.scrollTop = 400;
    }, 500);

    function getMineCost(mines) { return 100 + (mines * 100); }

    let dragging = null;
    function startDrag(type, cost) {
        sellMode = false; 
        document.getElementById('sell-btn').classList.remove('active');
        let actualCost = type === 'mine' ? getMineCost(gameState.p1.mines) : cost;
        
        if (gameState.p1.gold >= actualCost) {
            if (type === 'mine' && gameState.p1.mines >= 3) {
                alert('–ú–∞–∫—Å–∏–º—É–º 3 —à–∞—Ö—Ç—ã!');
                return;
            }
            if (type !== 'mine' && gameState.p1.combatBuildings >= 25) {
                alert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∑–¥–∞–Ω–∏–π!');
                return;
            }
            
            dragging = { type, cost: actualCost };
            dragIcon.style.display = "block";
            
            if (type === 'wall') {
                dragIcon.classList.add('wall-drag');
                dragIcon.innerHTML = "üß±";
                dragIcon.style.background = "rgba(0, 100, 200, 0.7)";
            } else {
                dragIcon.classList.remove('wall-drag');
                dragIcon.style.background = "rgba(0,0,255,0.5)";
                const icons = {
                    'barracks': 'üè†',
                    'archers': 'üèπ',
                    'mine': 'üíé',
                    'bomb': 'üí£',
                    'turret': 'üõ°Ô∏è'
                };
                dragIcon.innerHTML = icons[type] || 'üèóÔ∏è';
            }
        } else {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    container.addEventListener('touchstart', (e) => {
        if (!dragging) return;
        e.preventDefault();
    });

    container.addEventListener('touchmove', (e) => {
        if (!dragging) return;
        e.preventDefault();
        const touch = e.touches[0];
        dragIcon.style.left = touch.clientX + "px"; 
        dragIcon.style.top = touch.clientY + "px";
    });

    container.addEventListener('touchend', (e) => {
        if (!dragging) return;
        e.preventDefault();
        
        const touch = e.changedTouches[0];
        const cY = touch.clientY + container.scrollTop;
        const cX = touch.clientX;
        
        const w = dragging.type === 'wall' ? 80 : 40;
        const h = dragging.type === 'wall' ? 15 : 40;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç—å –º–µ—Å—Ç–∞
        const isOcc = gameState.buildings.some(b => {
            const bw = b.type === 'wall' ? 80 : 40;
            const bh = b.type === 'wall' ? 15 : 40;
            const bX = b.x;
            const bY = b.y;
            const newX = cX - w/2;
            const newY = cY - h/2;
            
            return !(newX + w < bX || newX > bX + bw || newY + h < bY || newY > bY + bh);
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –≤ –∑–æ–Ω–µ —Å–∏–Ω–µ–≥–æ –∏–≥—Ä–æ–∫–∞ (–Ω–∏–∂–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞)
        if (cY > canvas.height / 2 && cY < canvas.height - 50 && !isOcc) {
            gameState.p1.gold -= dragging.cost;
            
            if (dragging.type === 'mine') { 
                gameState.p1.income += 4; 
                gameState.p1.mines++; 
            } else { 
                if (dragging.type === 'bomb') gameState.p1.bombs++;
                else if (dragging.type === 'barracks') gameState.p1.barracks++;
                else if (dragging.type === 'archers') gameState.p1.archerHouses++;
                else if (dragging.type !== 'wall') gameState.p1.turrets++;
                gameState.p1.combatBuildings++; 
            }
            
            let hp = (dragging.type === 'wall') ? 900 : 
                    ((dragging.type === 'turret' || dragging.type === 'bomb') ? 550 : 350);
            
            gameState.buildings.push({ 
                type: dragging.type, 
                player: 1, 
                x: cX - w/2, 
                y: cY - h/2, 
                hp: hp, 
                maxHp: hp, 
                lastSpawn: Date.now(), 
                lastShot: 0 
            });
        }
        
        dragging = null; 
        dragIcon.style.display = "none";
    });

    // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ò–ò –∫—Ä–∞—Å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    function runAI() {
        let p2 = gameState.p2;
        
        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
        let enemyUnits = gameState.units.filter(u => u.player === 1).length;
        let enemyUnitsNearBase = gameState.units.filter(u => u.player === 1 && u.y > canvas.height * 0.6).length;
        
        let myWalls = gameState.buildings.filter(b => b.player === 2 && b.type === 'wall').length;
        let myTurrets = gameState.buildings.filter(b => b.player === 2 && b.type === 'turret').length;
        let myBombs = gameState.buildings.filter(b => b.player === 2 && b.type === 'bomb').length;
        let myBarracks = gameState.buildings.filter(b => b.player === 2 && b.type === 'barracks').length;
        let myArchers = gameState.buildings.filter(b => b.player === 2 && b.type === 'archers').length;
        
        let gold = p2.gold;
        
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —à–∞—Ö—Ç—ã
        if (p2.mines < 3 && gold >= getMineCost(p2.mines)) {
            tryPlaceBuilding('mine');
            return;
        }
        
        // –ï—Å–ª–∏ –º–Ω–æ–≥–æ –∑–æ–ª–æ—Ç–∞
        if (gold > 400) {
            if (myBombs < 2 && gold >= 200) {
                tryPlaceBuilding('bomb');
                return;
            }
            if (myWalls < 3 && gold >= 200) {
                tryPlaceBuilding('wall');
                return;
            }
            if (myTurrets < 6 && gold >= 70) {
                tryPlaceBuilding('turret');
                return;
            }
        }
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —É–≥—Ä–æ–∑–∞
        if (enemyUnitsNearBase > 0) {
            if (enemyUnitsNearBase > 2 && myWalls < 2 && gold >= 200) {
                tryPlaceBuilding('wall');
                return;
            }
            if (myTurrets < 4 && gold >= 70) {
                tryPlaceBuilding('turret');
                return;
            }
            if (myBombs < 1 && gold >= 200) {
                tryPlaceBuilding('bomb');
                return;
            }
        }
        
        // –†–∞–∑–≤–∏—Ç–∏–µ –∞—Ä–º–∏–∏
        if (p2.combatBuildings < 20 && gold >= 50) {
            if (myBarracks < 3 || gold > 300) {
                tryPlaceBuilding('barracks');
            } else if (myArchers < 2) {
                tryPlaceBuilding('archers');
            }
            return;
        }
        
        function tryPlaceBuilding(type) {
            let cost = 0;
            let yPos = 0;
            let xPos = canvas.width / 2 + (Math.random() - 0.5) * 200;
            
            switch(type) {
                case 'wall':
                    cost = 200;
                    yPos = 700 + Math.random() * 50;
                    break;
                case 'mine':
                    cost = getMineCost(p2.mines);
                    yPos = 500 + Math.random() * 100;
                    break;
                case 'bomb':
                    cost = 200;
                    yPos = 600 + Math.random() * 100;
                    break;
                case 'turret':
                    cost = 70;
                    yPos = 550 + Math.random() * 150;
                    break;
                case 'barracks':
                    cost = 50;
                    yPos = 450 + Math.random() * 100;
                    break;
                case 'archers':
                    cost = 150;
                    yPos = 500 + Math.random() * 100;
                    break;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ –∫—Ä–∞—è–º
            xPos = Math.max(50, Math.min(canvas.width - 90, xPos));
            
            if (p2.gold >= cost) {
                let w = type === 'wall' ? 80 : 40;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç—å
                if (!gameState.buildings.some(b => 
                    Math.abs(b.x - xPos) < 70 && Math.abs(b.y - yPos) < 50)) {
                    
                    p2.gold -= cost;
                    
                    if (type === 'mine') { 
                        p2.income += 4; 
                        p2.mines++; 
                    } else { 
                        if (type === 'bomb') p2.bombs++; 
                        else if (type === 'barracks') p2.barracks++; 
                        else if (type === 'archers') p2.archerHouses++; 
                        else if (type !== 'wall') p2.turrets++; 
                        p2.combatBuildings++; 
                    }
                    
                    let hp = (type === 'wall') ? 900 : 
                            ((type === 'turret' || type === 'bomb') ? 550 : 350);
                    
                    gameState.buildings.push({ 
                        type, 
                        player: 2, 
                        x: xPos, 
                        y: yPos, 
                        hp: hp, 
                        maxHp: hp, 
                        lastSpawn: Date.now(), 
                        lastShot: 0 
                    });
                }
            }
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ò–ò
    setInterval(runAI, 1000);

    // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
    function update() {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–∞
        gameState.p1.gold += gameState.p1.income / 120; // –ú–µ–¥–ª–µ–Ω–Ω–µ–µ
        gameState.p2.gold += gameState.p2.income / 120;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        document.getElementById("gold1").innerText = Math.floor(gameState.p1.gold);
        document.getElementById("gold2").innerText = Math.floor(gameState.p2.gold);
        document.getElementById("hp1").innerText = Math.floor(gameState.p1.hp);
        document.getElementById("hp2").innerText = Math.floor(gameState.p2.hp);
        document.getElementById("mines1").innerText = gameState.p1.mines;
        document.getEle
