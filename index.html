<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>War Castle Multiplayer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; }
        
        /* –°—Ç–∞—Ç—É—Å —Å–µ—Ç–∏ */
        #net-status { position: fixed; top: 10px; right: 10px; display: flex; align-items: center; gap: 8px; z-index: 1000; font-size: 12px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 20px; }
        #status-dot { width: 10px; height: 10px; background: #555; border-radius: 50%; }
        .online-dot { background: #00ff00 !important; box-shadow: 0 0 10px #00ff00; }

        /* –õ–æ–±–±–∏ */
        #lobby { position: fixed; inset: 0; background: radial-gradient(circle, #222, #000); z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #online-count { font-size: 20px; color: #00ff00; margin: 20px; text-shadow: 0 0 5px #000; }
        .play-btn { padding: 15px 50px; font-size: 24px; background: #4444ff; color: white; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 6px 0 #2222aa; transition: 0.1s; }
        .play-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #2222aa; }
        .play-btn:disabled { background: #555; box-shadow: none; opacity: 0.6; }

        /* –ò–≥—Ä–∞ */
        #game-ui { display: none; position: fixed; width: 100%; height: 100%; pointer-events: none; }
        .top-stats { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; font-size: 22px; font-weight: bold; }
        
        #shop { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 15px; pointer-events: auto; }
        .item { background: rgba(0,0,0,0.8); border: 2px solid #4444ff; width: 65px; height: 80px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .item.selected { border-color: #00ff00; background: #333; }
        
        canvas { display: block; background: #2d5a27; }
    </style>
</head>
<body>

<div id="net-status">
    <span id="status-label">OFFLINE</span>
    <div id="status-dot"></div>
</div>

<div id="lobby">
    <h1 style="font-size: 48px; margin: 0; color: #4444ff; text-shadow: 2px 2px #000;">WAR CASTLE</h1>
    <div id="online-count">–ò–ì–†–û–ö–û–í –í –°–ï–¢–ò: 0</div>
    <button class="play-btn" id="find-btn" onclick="requestMatch()">–í –ë–û–ô!</button>
</div>

<div id="game-ui">
    <div class="top-stats">
        <div style="color: gold;">üí∞ <span id="gold-txt">100</span></div>
        <div style="color: #ff4444;">‚ù§ –í–†–ê–ì: <span id="hp-txt">1000</span></div>
    </div>
    <div id="shop">
        <div class="item" id="btn-barracks" onclick="setMode('barracks', 50)">üè†<br><small>50</small></div>
        <div class="item" id="btn-mine" onclick="setMode('mine', 100)">üíé<br><small>100</small></div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // –ü–†–Ø–ú–û–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï
    const socket = io();
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    let playerRole = null;
    let room = null;
    let gold = 100;
    let enemyHp = 1000;
    let minesCount = 0;
    let selectedMode = null;
    let cost = 0;

    let state = { buildings: [], units: [] };

    // --- –°–ï–¢–ï–í–´–ï –°–û–ë–´–¢–ò–Ø ---
    socket.on('connect', () => {
        document.getElementById('status-dot').classList.add('online-dot');
        document.getElementById('status-label').innerText = "ONLINE";
    });

    socket.on('onlineUpdate', (count) => {
        document.getElementById('online-count').innerText = `–ò–ì–†–û–ö–û–í –í –°–ï–¢–ò: ${count}`;
    });

    function requestMatch() {
        socket.emit('findGame');
        document.getElementById('find-btn').innerText = "–ü–û–ò–°–ö...";
        document.getElementById('find-btn').disabled = true;
    }

    socket.on('startGame', (data) => {
        playerRole = data.role;
        room = data.room;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        resize();
        requestAnimationFrame(update);
    });

    socket.on('syncBuilding', (d) => {
        // –ó–µ—Ä–∫–∞–ª–∏–º –¥–ª—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
        addBuilding(d.type, d.role, canvas.width - d.x, canvas.height - d.y);
    });

    // --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    function setMode(m, c) {
        selectedMode = m;
        cost = c;
        document.querySelectorAll('.item').forEach(i => i.classList.remove('selected'));
        document.getElementById('btn-' + m).classList.add('selected');
    }

    canvas.addEventListener('pointerdown', (e) => {
        if (!selectedMode || gold < cost) return;
        // –°—Ç—Ä–æ–∏—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–≤–æ–µ–π –ø–æ–ª–æ–≤–∏–Ω–µ (–Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞)
        if (e.clientY > canvas.height / 2 + 50) {
            gold -= cost;
            addBuilding(selectedMode, playerRole, e.clientX, e.clientY);
            socket.emit('placeBuilding', { type: selectedMode, x: e.clientX, y: e.clientY, role: playerRole, room: room });
            selectedMode = null;
            document.querySelectorAll('.item').forEach(i => i.classList.remove('selected'));
        }
    });

    function addBuilding(type, role, x, y) {
        state.buildings.push({ type, role, x, y, lastSpawn: Date.now() });
        if (role === playerRole && type === 'mine') minesCount++;
    }

    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ü–æ–ª–µ (—Ç—Ä–∞–≤–∞ –∏ —Ü–µ–Ω—Ç—Ä)
        ctx.strokeStyle = "rgba(255,255,255,0.2)";
        ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();

        // –≠–∫–æ–Ω–æ–º–∏–∫–∞
        gold += (1.5 + minesCount * 2) / 60;
        document.getElementById('gold-txt').innerText = Math.floor(gold);

        // –†–∏—Å—É–µ–º –∑–¥–∞–Ω–∏—è
        state.buildings.forEach(b => {
            ctx.fillStyle = b.role === playerRole ? "#4444ff" : "#ff4444";
            const s = b.type === 'mine' ? 30 : 45;
            ctx.fillRect(b.x - s/2, b.y - s/2, s, s);

            // –ê–≤—Ç–æ-—Å–ø–∞–≤–Ω –≤–æ–∏–Ω–æ–≤
            if (b.type === 'barracks' && Date.now() - b.lastSpawn > 4000) {
                state.units.push({ x: b.x, y: b.y, role: b.role, speed: b.role === playerRole ? -2 : 2 });
                b.lastSpawn = Date.now();
            }
        });

        // –†–∏—Å—É–µ–º –≤–æ–∏–Ω–æ–≤
        state.units.forEach((u, i) => {
            u.y += u.speed;
            ctx.fillStyle = u.role === playerRole ? "#00ffff" : "#ffaa00";
            ctx.beginPath(); ctx.arc(u.x, u.y, 8, 0, Math.PI*2); ctx.fill();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–Ω–∞ –±–∞–∑–µ
            if (u.y < 0 || u.y > canvas.height) {
                if (u.role === playerRole) {
                    enemyHp -= 50;
                    document.getElementById('hp-txt').innerText = enemyHp;
                }
                state.units.splice(i, 1);
                if (enemyHp <= 0) { alert("–ü–û–ë–ï–î–ê!"); location.reload(); }
            }
        });

        requestAnimationFrame(update);
    }

    window.onresize = resize;
</script>
</body>
</html>
