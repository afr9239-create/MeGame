<!DOCTYPE html>
<html>
<head>
    <title>War Castle: Frontline Update</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #game-container { width: 100vw; height: 100vh; overflow-y: auto; overflow-x: hidden; position: relative; scrollbar-width: none; display: none; }
        #game-container::-webkit-scrollbar { display: none; }
        canvas { display: block; background: #355e3b; width: 100%; height: auto; }

        #menu-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-battle { background: #ff00ff; border: none; color: white; padding: 15px 50px; font-size: 24px; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px #ff00ff; }
        
        #ui { position: fixed; bottom: 10px; left: 0; width: 100%; display: none; justify-content: center; gap: 6px; z-index: 10; }
        .shop-item { background: rgba(30, 30, 30, 0.95); border: 2px solid #4444ff; width: 55px; height: 65px; text-align: center; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 10px; }
        
        .stats { position: fixed; top: 5px; width: 100%; display: none; justify-content: space-between; padding: 0 10px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .stat-card { background: rgba(0,0,0,0.7); padding: 6px 12px; border-radius: 8px; font-size: 11px; border-left: 4px solid #4444ff; }
        .red-side { border-left: 0; border-right: 4px solid #ff4444; text-align: right; }
        #drag-icon { position: fixed; width: 35px; height: 35px; background: rgba(255,255,255,0.3); border: 2px solid #fff; display: none; pointer-events: none; transform: translate(-50%, -50%); z-index: 100; text-align: center; line-height: 35px; border-radius: 50%; }
    </style>
</head>
<body>

<div id="menu-screen">
    <h1>WAR CASTLE</h1>
    <button class="btn-battle" onclick="findMatch()">–í –ë–û–ô</button>
    <p id="online-count">–ò–≥—Ä–æ–∫–æ–≤: 0</p>
</div>

<div class="stats" id="stats-ui">
    <div class="stat-card">üí∞<span id="gold1">0</span> | üè∞ <span id="hp1">500</span></div>
    <div class="stat-card red-side">üè∞ <span id="hp2">500</span> | üí∞<span id="gold2">0</span></div>
</div>

<div id="ui">
    <div class="shop-item" ontouchstart="startDrag('barracks', 50)">üè† 50</div>
    <div class="shop-item" ontouchstart="startDrag('archers', 150)">üèπ 150</div>
    <div class="shop-item" ontouchstart="startDrag('wall', 200)">üß± 200</div>
    <div class="shop-item" ontouchstart="startDrag('turret', 70)">üõ°Ô∏è 70</div>
    <div class="shop-item" ontouchstart="startDrag('bomb', 200)">üí£ 200</div>
    <div class="shop-item" ontouchstart="startDrag('mine', 100)">üíé <span id="mine-cost-ui">100</span></div>
</div>

<div id="drag-icon"></div>
<div id="game-container"><canvas id="gameCanvas"></canvas></div>

<script>
const socket = io("https://war-castle.onrender.com");
let gameStarted = false, lastTime = Date.now();
const canvas = document.getElementById("gameCanvas"), ctx = canvas.getContext("2d");
const container = document.getElementById("game-container"), dragIcon = document.getElementById("drag-icon");

let gameState = {
    p1: { gold: 120, hp: 500, income: 3, mines: 0 }, 
    p2: { gold: 120, hp: 500, income: 3, mines: 0 }, 
    units: [], buildings: [], projectiles: [], vfx: []
};

socket.on('playerUpdate', (count) => { document.getElementById('online-count').innerText = `–ò–≥—Ä–æ–∫–æ–≤: ${count}`; });
function findMatch() { socket.emit('findMatch'); }
socket.on('matchFound', () => { 
    gameStarted = true;
    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('ui').style.display = 'flex';
    document.getElementById('stats-ui').style.display = 'flex';
    container.style.display = 'block';
    resize();
    setTimeout(() => container.scrollTop = canvas.height, 200);
    update();
});

socket.on('syncEnemyResources', (data) => { gameState.p2.gold = data.gold; gameState.p2.hp = data.hp; });
socket.on('enemySpawn', (data) => {
    let w = data.type === 'wall' ? 80 : 40;
    gameState.buildings.push({ type: data.type, player: 2, x: canvas.width - data.x - w, y: canvas.height - data.y - 40, hp: data.hp, maxHp: data.hp, lastSpawn: Date.now(), lastShot: 0 });
});

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight * 2.5; }

let dragging = null;
function startDrag(type, cost) {
    let actualCost = type === 'mine' ? 100 + (gameState.p1.mines * 100) : cost;
    if (gameState.p1.gold >= actualCost) {
        dragging = { type, cost: actualCost };
        dragIcon.style.display = "block";
        dragIcon.innerHTML = type === 'wall' ? "üß±" : "üì¶";
    }
}

window.ontouchmove = (e) => { if (dragging) { dragIcon.style.left = e.touches[0].clientX + "px"; dragIcon.style.top = e.touches[0].clientY + "px"; } };
window.ontouchend = (e) => {
    if (!dragging) return;
    let touch = e.changedTouches[0], cY = touch.clientY + container.scrollTop, cX = touch.clientX;
    if (cY > canvas.height / 2 && cY < canvas.height - 70) {
        gameState.p1.gold -= dragging.cost;
        let hp = dragging.type === 'wall' ? 1200 : 450;
        socket.emit('spawnUnit', { type: dragging.type, x: cX - 20, y: cY - 20, hp: hp });
        if (dragging.type === 'mine') gameState.p1.mines++;
        gameState.buildings.push({ type: dragging.type, player: 1, x: cX - 20, y: cY - 20, hp: hp, maxHp: hp, lastSpawn: Date.now(), lastShot: 0 });
    }
    dragging = null; dragIcon.style.display = "none";
};

function update() {
    if(!gameStarted) return;
    
    // –§–û–ù–û–í–û–ï –ó–û–õ–û–¢–û: —Å—á–∏—Ç–∞–µ–º –¥–µ–ª—å—Ç—É –≤—Ä–µ–º–µ–Ω–∏
    let now = Date.now();
    let dt = (now - lastTime) / 1000; // —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    lastTime = now;
    
    gameState.p1.gold += (gameState.p1.income + (gameState.p1.mines * 4)) * dt;
    socket.emit('syncResources', { gold: gameState.p1.gold, hp: gameState.p1.hp });

    document.getElementById("gold1").innerText = Math.floor(gameState.p1.gold);
    document.getElementById("gold2").innerText = Math.floor(gameState.p2.gold);
    document.getElementById("hp1").innerText = Math.floor(gameState.p1.hp);
    document.getElementById("hp2").innerText = Math.floor(gameState.p2.hp);

    // –õ–æ–≥–∏–∫–∞ –±–æ—è (–ê–≥—Ä)
    gameState.units.forEach((u, i) => {
        let range = u.type === 'archer' ? 160 : 45;
        let target = null, minDist = 200;
        
        // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤—Ä–∞–≥–∞ (—é–Ω–∏—Ç –∏–ª–∏ –∑–¥–∞–Ω–∏–µ)
        gameState.buildings.concat(gameState.units).forEach(obj => {
            if (obj.player !== u.player) {
                let d = Math.hypot(obj.x - u.x, obj.y - u.y);
                if (d < minDist) { minDist = d; target = obj; }
            }
        });

        if (target && minDist < range) {
            // –ê—Ç–∞–∫–∞
            if (u.type === 'archer') {
                if (Date.now() - (u.lastShot || 0) > 1500) {
                    gameState.projectiles.push({ x: u.x, y: u.y, target, type: 'arrow', player: u.player });
                    u.lastShot = Date.now();
                }
            } else { target.hp -= 1.5; }
        } else {
            // –î–≤–∏–∂–µ–Ω–∏–µ –∫ –±–∞–∑–µ –≤—Ä–∞–≥–∞ –µ—Å–ª–∏ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç —Ä—è–¥–æ–º
            u.y += u.speed;
        }

        if (u.y < 60 && u.player === 1) { gameState.p2.hp -= 40; u.hp = 0; }
        if (u.y > canvas.height - 60 && u.player === 2) { gameState.p1.hp -= 40; u.hp = 0; }
        if (u.hp <= 0) gameState.units.splice(i, 1);
    });

    // –õ–æ–≥–∏–∫–∞ –∑–¥–∞–Ω–∏–π –∏ —Å–Ω–∞—Ä—è–¥–æ–≤
    gameState.buildings.forEach(b => {
        let shotCD = b.type === 'bomb' ? 3500 : 1200;
        if ((b.type === 'turret' || b.type === 'bomb') && Date.now() - b.lastShot > shotCD) {
            let target = gameState.units.find(u => u.player !== b.player && Math.hypot(u.x-b.x, u.y-b.y) < 300);
            if (target) { gameState.projectiles.push({ x: b.x+20, y: b.y+20, target, type: b.type, player: b.player }); b.lastShot = Date.now(); }
        }
    });

    gameState.projectiles.forEach((p, pi) => {
        let dx = p.target.x - p.x, dy = p.target.y - p.y, dist = Math.hypot(dx, dy);
        if (dist < 10) {
            if (p.type === 'bomb') { // Splash damage
                gameState.vfx.push({ x: p.x, y: p.y, time: Date.now() });
                gameState.units.forEach(u => { if(u.player !== p.player && Math.hypot(u.x-p.x, u.y-p.y) < 90) u.hp -= 80; });
            } else { p.target.hp -= 30; }
            gameState.projectiles.splice(pi, 1);
        } else { p.x += dx/dist*8; p.y += dy/dist*8; }
    });

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#355e3b"; ctx.fillRect(0,0, canvas.width, canvas.height);
    
    // –õ–ò–ù–ò–Ø –¶–ï–ù–¢–†–ê –ò –ó–û–ù–´
    ctx.fillStyle = "rgba(255, 0, 0, 0.1)"; ctx.fillRect(0, 0, canvas.width, canvas.height/2);
    ctx.fillStyle = "rgba(0, 0, 255, 0.1)"; ctx.fillRect(0, canvas.height/2, canvas.width, canvas.height/2);
    ctx.strokeStyle = "white"; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();

    gameState.buildings.forEach(b => {
        let color = b.player === 1 ? "#4444ff" : "#ff4444";
        ctx.fillStyle = color;
        if (b.type === 'turret') {
            ctx.fillRect(b.x+10, b.y+10, 20, 20); // –û—Å–Ω–æ–≤–∞–Ω–∏–µ
            ctx.fillStyle = "black"; ctx.fillRect(b.x+18, b.y-5, 4, 20); // –°—Ç–≤–æ–ª
        } else if (b.type === 'bomb') {
            ctx.beginPath(); ctx.arc(b.x+20, b.y+20, 20, 0, Math.PI*2); ctx.fill(); // –ú–æ—â–Ω–∞—è –ø—É—à–∫–∞
            ctx.fillStyle = "#333"; ctx.fillRect(b.x+10, b.y-10, 20, 25);
        } else { ctx.fillRect(b.x, b.y, b.type==='wall'?80:40, 40); }
        
        // –•–ü –ë–ê–†–´ –ó–î–ê–ù–ò–ô
        ctx.fillStyle = "black"; ctx.fillRect(b.x, b.y-10, 40, 5);
        ctx.fillStyle = b.player === 1 ? "#00f" : "#f00"; ctx.fillRect(b.x, b.y-10, (b.hp/b.maxHp)*40, 5);
    });

    gameState.units.forEach(u => {
        ctx.fillStyle = u.player === 1 ? "#4444ff" : "#ff4444";
        ctx.beginPath(); ctx.arc(u.x, u.y, 14, 0, Math.PI*2); ctx.fill();
        // –•–ü –ë–ê–†–´ –Æ–ù–ò–¢–û–í
        ctx.fillStyle = "black"; ctx.fillRect(u.x-15, u.y-22, 30, 4);
        ctx.fillStyle = u.player === 1 ? "#44f" : "#f44"; ctx.fillRect(u.x-15, u.y-22, (u.hp/u.maxHp)*30, 4);
    });

    gameState.projectiles.forEach(p => { ctx.fillStyle = p.type==='bomb'?'#000':'#fff'; ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill(); });
}
</script>
</body>
</html>
