<!DOCTYPE html>
<html>
<head>
    <title>War Castle: Fix & Build</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #0a0a0a; overflow: hidden; font-family: sans-serif; touch-action: none; }
        canvas { display: block; }

        #ui-inventory {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; background: rgba(0,0,0,0.85); padding: 10px 25px; 
            border-radius: 15px; border: 1px solid #444; z-index: 100; pointer-events: none;
        }
        .res-item { color: white; font-size: 20px; font-weight: bold; display: flex; align-items: center; gap: 8px; }

        #build-btn {
            position: fixed; bottom: 30px; right: 30px; width: 80px; height: 80px;
            background: #2e7d32; border: 4px solid #fff; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 35px; z-index: 500; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        #build-menu {
            position: fixed; bottom: 120px; right: 30px; display: none;
            flex-direction: column; gap: 10px; z-index: 500;
        }
        .menu-opt { background: #1b5e20; border: 2px solid #fff; padding: 12px; border-radius: 12px; color: white; text-align: center; }

        #joy-base {
            position: fixed; bottom: 40px; left: 40px; width: 120px; height: 120px;
            background: rgba(255,255,255,0.05); border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
        }
        #joy-knob { position: absolute; top: 40px; left: 40px; width: 40px; height: 40px; background: #fff; border-radius: 50%; }
        
        #msg { position: fixed; top: 80px; width: 100%; text-align: center; color: #4caf50; font-weight: bold; pointer-events: none; }
    </style>
</head>
<body>

<div id="ui-inventory">
    <div class="res-item">ü™µ <span id="w-val">50</span></div>
    <div class="res-item">ü™® <span id="s-val">50</span></div>
</div>

<div id="msg"></div>
<div id="build-btn">‚öíÔ∏è</div>
<div id="build-menu">
    <div class="menu-opt" onclick="initDrag('drill')">–ë–£–†<br><small>20ü™® 10ü™µ</small></div>
</div>

<div id="joy-base"><div id="joy-knob"></div></div>
<canvas id="gameCanvas"></canvas>

<script>
const socket = io("https://war-castle.onrender.com");
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const WORLD_SIZE = 7000;
let myID = null;
let inventory = { wood: 50, stone: 50 };
let myPos = { x: 0, y: 0, angle: 0, atk: false, atkP: 0 };
let moveDir = { x: 0, y: 0 };
const speed = 10;

let players = {};
let buildings = [];
let staticObjects = [];
let deco = [];

let isDragging = false;
let dragPos = { x: 0, y: 0 };

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏—Ä–∞
function setupWorld() {
    for(let i=0; i<25; i++) {
        staticObjects.push({
            x: (Math.random()-0.5)*6000,
            y: (Math.random()-0.5)*6000,
            type: Math.random() > 0.4 ? 'stone' : 'tree',
            size: 130 + Math.random()*50
        });
    }
    for(let i=0; i<400; i++) {
        deco.push({ x: (Math.random()-0.5)*WORLD_SIZE, y: (Math.random()-0.5)*WORLD_SIZE, s: 15 });
    }
}
setupWorld();

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
let joyId = null;
const joyKnob = document.getElementById("joy-knob");

document.getElementById('build-btn').onclick = (e) => {
    e.stopPropagation();
    const m = document.getElementById('build-menu');
    m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
};

function initDrag(type) {
    if(inventory.stone >= 20 && inventory.wood >= 10) {
        isDragging = true;
        dragPos = { x: myPos.x, y: myPos.y };
        document.getElementById('build-menu').style.display = 'none';
        document.getElementById('msg').innerText = "–¢–ê–©–ò –ò –û–¢–ü–£–°–¢–ò –î–õ–Ø –ü–û–°–¢–†–û–ô–ö–ò";
    }
}

window.addEventListener('touchstart', e => {
    for(let t of e.changedTouches) {
        if(t.clientX < 250 && t.clientY > window.innerHeight - 250) {
            joyId = t.identifier;
        } else if(!isDragging) {
            let wx = (t.clientX - canvas.width/2)/0.2 + myPos.x;
            let wy = (t.clientY - canvas.height/2)/0.2 + myPos.y;
            let collected = false;
            buildings.forEach(b => {
                if(Math.sqrt((b.x-wx)**2 + (b.y-wy)**2) < 150) {
                    inventory.stone += b.storage; b.storage = 0; updateUI(); collected = true;
                }
            });
            if(!collected && !myPos.atk) { myPos.atk = true; myPos.atkP = -0.8; }
        }
    }
});

window.addEventListener('touchmove', e => {
    for(let t of e.touches) {
        if(t.identifier === joyId) {
            let dx = t.clientX - 100, dy = t.clientY - (window.innerHeight - 100);
            let d = Math.sqrt(dx*dx + dy*dy);
            if(d > 50) { dx *= 50/d; dy *= 50/d; }
            joyKnob.style.transform = `translate(${dx}px, ${dy}px)`;
            moveDir = { x: dx/50, y: dy/50 };
            myPos.angle = Math.atan2(dy, dx);
        }
        if(isDragging) {
            dragPos.x = (t.clientX - canvas.width/2)/0.2 + myPos.x;
            dragPos.y = (t.clientY - canvas.height/2)/0.2 + myPos.y;
        }
    }
}, {passive: false});

window.addEventListener('touchend', e => {
    for(let t of e.changedTouches) {
        if(t.identifier === joyId) { joyId = null; joyKnob.style.transform = `translate(0,0)`; moveDir = { x: 0, y: 0 }; }
        if(isDragging) {
            buildings.push({ x: dragPos.x, y: dragPos.y, storage: 0, lastTick: Date.now() });
            inventory.stone -= 20; inventory.wood -= 10; updateUI();
            isDragging = false; document.getElementById('msg').innerText = "";
        }
    }
});

function updateUI() {
    document.getElementById('w-val').innerText = inventory.wood;
    document.getElementById('s-val').innerText = inventory.stone;
}

socket.on('connect', () => { myID = socket.id; });
socket.on('update', sP => { players = sP; });

function loop() {
    myPos.x += moveDir.x * speed;
    myPos.y += moveDir.y * speed;

    if(myPos.atk) {
        myPos.atkP += 0.15;
        if(myPos.atkP >= 0.3 && myPos.atkP <= 0.4) {
            staticObjects.forEach(obj => {
                if(Math.sqrt((obj.x-myPos.x)**2 + (obj.y-myPos.y)**2) < obj.size + 150) {
                    if(obj.type === 'tree') inventory.wood++; else inventory.stone++;
                    updateUI();
                }
            });
        }
        if(myPos.atkP > 1.5) { myPos.atk = false; myPos.atkP = 0; }
    }

    buildings.forEach(b => {
        if(Date.now() - b.lastTick > 2000) {
            if(staticObjects.some(s => s.type === 'stone' && Math.sqrt((s.x-b.x)**2 + (s.y-b.y)**2) < 400)) {
                if(b.storage < 20) b.storage++;
            }
            b.lastTick = Date.now();
        }
    });

    socket.emit('move', { x: myPos.x, y: myPos.y, angle: myPos.angle, atk: myPos.atk, atkP: myPos.atkP });
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    ctx.fillStyle = "#0a0a0a"; ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(0.2, 0.2);
    ctx.translate(-myPos.x, -myPos.y);

    // –§–æ–Ω –º–∏—Ä–∞
    ctx.fillStyle = "#1b2b1b";
    ctx.fillRect(-WORLD_SIZE/2, -WORLD_SIZE/2, WORLD_SIZE, WORLD_SIZE);

    // –î–µ–∫–æ—Ä (—Ç—Ä–∞–≤–∞)
    ctx.fillStyle = "#2d442d";
    deco.forEach(d => { ctx.fillRect(d.x, d.y, d.s, d.s); });

    // –ü–æ—Å—Ç—Ä–æ–π–∫–∏
    buildings.forEach(b => {
        ctx.save();
        ctx.translate(b.x, b.y);
        ctx.fillStyle = "#444"; ctx.fillRect(-100,-100,200,200);
        ctx.rotate(Date.now()*0.005);
        ctx.fillStyle = "#888"; ctx.beginPath(); ctx.moveTo(0,-80); ctx.lineTo(60,60); ctx.lineTo(-60,60); ctx.fill();
        ctx.restore();
        ctx.fillStyle = "#fff"; ctx.font = "bold 50px Arial"; ctx.fillText(`üì¶ ${b.storage}`, b.x-50, b.y-120);
    });

    // –†–µ—Å—É—Ä—Å—ã
    staticObjects.forEach(obj => {
        ctx.fillStyle = obj.type === 'tree' ? "#0d3d0d" : "#37474f";
        ctx.beginPath(); ctx.arc(obj.x, obj.y, obj.size, 0, Math.PI*2); ctx.fill();
    });

    // –ò–≥—Ä–æ–∫–∏
    for(let id in players) {
        let p = players[id];
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.angle);
        
        // –ú–æ–ª–æ—Ç (–¢–µ–∫—Å—Ç—É—Ä–∞)
        ctx.save();
        let r=0, o=0; if(p.atk){ if(p.atkP<0) r=p.atkP*1.5; else { r=Math.sin(p.atkP*Math.PI)*2.2; o=Math.sin(p.atkP*Math.PI)*70; } }
        ctx.rotate(r);
        ctx.fillStyle = "#5d4037"; ctx.fillRect(o+15, -120, 35, 240);
        ctx.fillStyle = "#212121"; ctx.fillRect(o-40, -130, 150, 90); ctx.fillRect(o-40, 40, 150, 90);
        ctx.restore();

        // –¢–µ–ª–æ
        let grad = ctx.createRadialGradient(0,0,0,0,0,100);
        grad.addColorStop(0, id === myID ? "#8bc34a" : "#ff5252");
        grad.addColorStop(1, id === myID ? "#33691e" : "#b71c1c");
        ctx.fillStyle = grad;
        ctx.beginPath(); ctx.arc(0,0,95,0,Math.PI*2); ctx.fill();
        ctx.restore();
    }

    if(isDragging) {
        ctx.globalAlpha = 0.5; ctx.fillStyle = "cyan"; ctx.fillRect(dragPos.x-100, dragPos.y-100, 200, 200); ctx.globalAlpha = 1;
    }

    ctx.restore();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
