<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fantasy Duel: Battle Fixed</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a2b1a; font-family: sans-serif; user-select: none; color: white; }
        canvas { display: block; width: 100vw; height: 100vh; touch-action: none; }
        .hp-container { position: absolute; width: 120px; height: 12px; background: rgba(0,0,0,0.6); border: 2px solid #fff; border-radius: 10px; overflow: hidden; display: none; }
        .hp-bar { width: 100%; height: 100%; transition: width 0.3s; }
        #ui-blue { top: 20px; left: 20px; } #hp-blue { background: #00d2ff; }
        #ui-red { top: 20px; right: 20px; } #hp-red { background: #ff4757; }
        .mana-display { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px; display: none; border: 1px solid white; }
        #shop { position: absolute; bottom: 20px; right: 20px; display: none; }
        .card { width: 70px; height: 70px; background: #5d4037; border: 3px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        .btn { padding: 15px 40px; background: #2ecc71; color: white; border: none; border-radius: 10px; font-size: 1.2rem; margin-top: 20px; }
    </style>
</head>
<body>

<div id="ui-blue" class="hp-container"><div id="hp-blue" class="hp-bar"></div></div>
<div id="ui-red" class="hp-container"><div id="hp-red" class="hp-bar"></div></div>
<div id="mana-box" class="mana-display">MANA: <span id="mana">500</span></div>
<div id="shop"><div class="card" onclick="spawnUnitNet()">DEPLOY</div></div>

<div id="game-menu" class="overlay">
    <h1>FANTASY DUEL</h1>
    <p id="status">Подключение к серверу...</p>
    <button id="start-btn" class="btn" onclick="socket.emit('startGame')" style="display:none">НАЧАТЬ ИГРУ</button>
</div>

<div id="win-screen" class="overlay" style="display:none"><h1>ПОБЕДА!</h1><button class="btn" onclick="location.reload()">В МЕНЮ</button></div>
<div id="lose-screen" class="overlay" style="display:none"><h1>ПОРАЖЕНИЕ...</h1><button class="btn" onclick="location.reload()">В МЕНЮ</button></div>

<canvas id="game"></canvas>

<script>
    const socket = io('https://megame-server.onrender.com', { transports: ['websocket'] });
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    let mySide = null, gameState = 'MENU';
    let pBlue = { hp: 100, money: 500 }, pRed = { hp: 100, money: 500 };
    let units = [], cameraY = 0;
    const roadWidth = 600, roadLength = 1500;

    const mapImg = new Image(); mapImg.src = 'map.jpg';
    const bazaImg = new Image(); bazaImg.src = 'baza.jpg';

    socket.on('playerRole', role => {
        mySide = role;
        document.getElementById('status').innerText = "Ты Игрок " + role + ". Ждем противника...";
    });

    socket.on('playerCount', count => {
        if(count >= 2) {
            document.getElementById('status').innerText = "Противник найден!";
            if(mySide === 2) document.getElementById('start-btn').style.display = 'block';
        }
    });

    socket.on('gameStart', () => {
        gameState = 'PLAYING';
        document.getElementById('game-menu').style.display = 'none';
        document.querySelectorAll('.hp-container, .mana-display, #shop').forEach(el => el.style.display = 'block');
    });

    socket.on('spawnUnit', data => { units.push(data); });

    function spawnUnitNet() {
        let money = (mySide === 2) ? pBlue.money : pRed.money;
        if(money >= 50 && gameState === 'PLAYING') {
            if(mySide === 2) pBlue.money -= 50; else pRed.money -= 50;
            const unit = {
                id: Date.now() + Math.random(),
                x: (Math.random() * (roadWidth - 100)) - (roadWidth/2 - 50),
                y: (mySide === 1) ? -roadLength + 100 : roadLength - 100,
                side: mySide, hp: 100,
                color: (mySide === 1) ? '#ff4757' : '#00d2ff'
            };
            units.push(unit);
            socket.emit('spawnUnit', unit);
            updateUI();
        }
    }

    function updateUI() {
        document.getElementById('mana').innerText = Math.floor(mySide === 2 ? pBlue.money : pRed.money);
        document.getElementById('hp-blue').style.width = pBlue.hp + '%';
        document.getElementById('hp-red').style.width = pRed.hp + '%';
        
        if(pBlue.hp <= 0) endGame(mySide === 1 ? 'WIN' : 'LOSE');
        if(pRed.hp <= 0) endGame(mySide === 2 ? 'WIN' : 'LOSE');
    }

    function endGame(result) {
        gameState = 'FINISHED';
        document.getElementById(result === 'WIN' ? 'win-screen' : 'lose-screen').style.display = 'flex';
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2 + cameraY);

        // Трава
        ctx.fillStyle = '#1a2b1a';
        ctx.fillRect(-canvas.width, -roadLength - 500, canvas.width*2, roadLength*2 + 1000);

        // Дорога
        if(mapImg.complete) {
            for(let y = -roadLength; y < roadLength; y += 400) {
                ctx.drawImage(mapImg, -roadWidth/2, y, roadWidth, 401);
            }
        }
        
        // Базы
        if(bazaImg.complete) {
            ctx.drawImage(bazaImg, -roadWidth/2, -roadLength - 100, roadWidth, 200);
            ctx.drawImage(bazaImg, -roadWidth/2, roadLength - 100, roadWidth, 200);
        }

        // Юниты
        for(let i = units.length - 1; i >= 0; i--) {
            let u = units[i], fighting = false;
            for(let j = 0; j < units.length; j++) {
                let o = units[j];
                if(u.side !== o.side && Math.abs(u.y - o.y) < 40 && Math.abs(u.x - o.x) < 40) {
                    fighting = true; o.hp -= 0.5;
                }
            }
            if(!fighting) u.y += (u.side === 1) ? 2 : -2;

            ctx.fillStyle = u.color;
            ctx.beginPath(); ctx.arc(u.x, u.y, 15, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'red'; ctx.fillRect(u.x-15, u.y-25, 30, 4);
            ctx.fillStyle = 'lime'; ctx.fillRect(u.x-15, u.y-25, 30*(u.hp/100), 4);

            if(u.side === 2 && u.y < -roadLength) { pRed.hp -= 5; units.splice(i,1); updateUI(); }
            else if(u.side === 1 && u.y > roadLength) { pBlue.hp -= 5; units.splice(i,1); updateUI(); }
            else if(u.hp <= 0) units.splice(i,1);
        }
        ctx.restore();
        requestAnimationFrame(draw);
    }

    let isDrag = false, lastY = 0;
    canvas.onmousedown = e => { isDrag = true; lastY = e.clientY; };
    window.onmousemove = e => { if(isDrag) { cameraY += e.clientY - lastY; lastY = e.clientY; } };
    window.onmouseup = () => isDrag = false;
    canvas.ontouchstart = e => { isDrag = true; lastY = e.touches[0].clientY; };
    canvas.ontouchmove = e => { if(isDrag) { cameraY += e.touches[0].clientY - lastY; lastY = e.touches[0].clientY; e.preventDefault(); } };
    canvas.ontouchend = () => isDrag = false;

    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    setInterval(() => { if(gameState === 'PLAYING') { pBlue.money += 10; pRed.money += 10; updateUI(); } }, 1000);
    draw();
</script>
</body>
</html>
