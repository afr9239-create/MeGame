<!DOCTYPE html>
<html>
<head>
    <title>War Castle: Arena PVP Full</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #game-container { width: 100vw; height: 100vh; overflow-y: auto; overflow-x: hidden; position: relative; scrollbar-width: none; display: none; }
        #game-container::-webkit-scrollbar { display: none; }
        canvas { display: block; background: #355e3b; width: 100%; height: auto; }

        /* –ú–ï–ù–Æ */
        #menu-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-battle { background: #ff00ff; border: none; color: white; padding: 15px 50px; font-size: 24px; font-weight: bold; border-radius: 50px; cursor: pointer; }
        .searching-text { color: #00ffff; margin-top: 20px; display: none; }
        
        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        #ui { position: fixed; bottom: 10px; left: 0; width: 100%; display: none; justify-content: center; gap: 6px; z-index: 10; }
        .shop-item { background: rgba(30, 30, 30, 0.95); border: 2px solid #4444ff; width: 55px; height: 65px; text-align: center; border-radius: 8px; font-size: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .stats { position: fixed; top: 5px; width: 100%; display: none; justify-content: space-between; padding: 0 10px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .stat-card { background: rgba(0,0,0,0.7); padding: 6px 12px; border-radius: 8px; font-size: 11px; border-left: 4px solid #4444ff; }
        .red-side { border-left: 0; border-right: 4px solid #ff4444; text-align: right; }
        
        #drag-icon { position: fixed; width: 40px; height: 40px; background: rgba(255,255,255,0.2); border: 2px solid #fff; display: none; pointer-events: none; transform: translate(-50%, -50%); z-index: 100; text-align: center; line-height: 40px; font-size: 24px; }
    </style>
</head>
<body>

<div id="menu-screen">
    <h1 style="color: #fff;">WAR CASTLE</h1>
    <button class="btn-battle" onclick="findMatch()">–í –ë–û–ô</button>
    <div id="search-status" class="searching-text">–ü–û–ò–°–ö –°–û–ü–ï–†–ù–ò–ö–ê...</div>
    <p id="online-count" style="color: #444;">–ò–≥—Ä–æ–∫–æ–≤: 0</p>
</div>

<div class="stats" id="stats-ui">
    <div class="stat-card">üí∞<span id="gold1">0</span> | üè∞ <span id="hp1">500</span></div>
    <div class="stat-card red-side">üè∞ <span id="hp2">500</span> | üí∞<span id="gold2">0</span></div>
</div>

<div id="ui">
    <div class="shop-item" ontouchstart="startDrag('barracks', 50)">üè† 50</div>
    <div class="shop-item" ontouchstart="startDrag('archers', 150)">üèπ 150</div>
    <div class="shop-item" ontouchstart="startDrag('wall', 200)">üß± 200</div>
    <div class="shop-item" ontouchstart="startDrag('turret', 70)">üõ°Ô∏è 70</div>
    <div class="shop-item" ontouchstart="startDrag('bomb', 200)">üí£ 200</div>
    <div class="shop-item" ontouchstart="startDrag('mine', 100)">üíé <span id="mine-cost-ui">100</span></div>
</div>

<div id="drag-icon"></div>
<div id="game-container"><canvas id="gameCanvas"></canvas></div>

<script>
const socket = io("https://war-castle.onrender.com");
let gameStarted = false;
let isSearching = false;
const ATTACK_RANGE = 320;

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const container = document.getElementById("game-container");
const dragIcon = document.getElementById("drag-icon");

let gameState = {
    p1: { gold: 100, hp: 500, income: 3, mines: 0 }, 
    p2: { gold: 100, hp: 500, income: 3, mines: 0 }, 
    units: [], buildings: [], projectiles: [], vfx: []
};

// --- –°–ï–¢–¨ ---
socket.on('playerUpdate', (count) => { document.getElementById('online-count').innerText = `–ò–≥—Ä–æ–∫–æ–≤: ${count}`; });
function findMatch() { 
    isSearching = true; 
    document.getElementById('search-status').style.display = 'block'; 
    socket.emit('findMatch'); 
}
socket.on('matchFound', () => { 
    gameStarted = true;
    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('ui').style.display = 'flex';
    document.getElementById('stats-ui').style.display = 'flex';
    container.style.display = 'block';
    resize();
    setTimeout(() => container.scrollTop = canvas.height, 200);
    update();
});

socket.on('syncEnemyResources', (data) => { gameState.p2.gold = data.gold; gameState.p2.hp = data.hp; });
socket.on('enemySpawn', (data) => {
    let mirroredX = canvas.width - data.x - (data.type === 'wall' ? 80 : 40);
    let mirroredY = canvas.height - data.y - 40;
    gameState.buildings.push({ type: data.type, player: 2, x: mirroredX, y: mirroredY, hp: data.type === 'wall' ? 1200 : 450, maxHp: data.type === 'wall' ? 1200 : 450, lastSpawn: Date.now(), lastShot: 0 });
});

// --- –õ–û–ì–ò–ö–ê ---
let dragging = null;
function startDrag(type, cost) {
    let actualCost = type === 'mine' ? 100 + (gameState.p1.mines * 100) : cost;
    if (gameState.p1.gold >= actualCost) {
        dragging = { type, cost: actualCost };
        dragIcon.style.display = "block";
        dragIcon.innerHTML = type === 'barracks' ? 'üè†' : (type === 'mine' ? 'üíé' : 'üõ°Ô∏è');
    }
}

window.addEventListener('touchmove', (e) => { if (dragging) { dragIcon.style.left = e.touches[0].clientX + "px"; dragIcon.style.top = e.touches[0].clientY + "px"; } });

window.addEventListener('touchend', (e) => {
    if (!dragging) return;
    let touch = e.changedTouches[0], cY = touch.clientY + container.scrollTop, cX = touch.clientX;
    if (cY > canvas.height / 2 && cY < canvas.height - 70) {
        gameState.p1.gold -= dragging.cost;
        socket.emit('spawnUnit', { type: dragging.type, x: cX - 20, y: cY - 20 });
        if (dragging.type === 'mine') { gameState.p1.income += 4; gameState.p1.mines++; }
        gameState.buildings.push({ type: dragging.type, player: 1, x: cX - 20, y: cY - 20, hp: dragging.type === 'wall' ? 1200 : 450, maxHp: dragging.type === 'wall' ? 1200 : 450, lastSpawn: Date.now(), lastShot: 0 });
    }
    dragging = null; dragIcon.style.display = "none";
});

function update() {
    if(!gameStarted) return;
    socket.emit('syncResources', { gold: gameState.p1.gold, hp: gameState.p1.hp });
    gameState.p1.gold += gameState.p1.income / 60;
    
    document.getElementById("gold1").innerText = Math.floor(gameState.p1.gold);
    document.getElementById("gold2").innerText = Math.floor(gameState.p2.gold);
    document.getElementById("hp1").innerText = Math.floor(gameState.p1.hp);
    document.getElementById("hp2").innerText = Math.floor(gameState.p2.hp);

    // –õ–æ–≥–∏–∫–∞ –∑–¥–∞–Ω–∏–π (—Å—Ç—Ä–µ–ª—å–±–∞ –∏ —Å–ø–∞–≤–Ω)
    gameState.buildings.forEach((b, bi) => {
        let spawnCD = b.type === 'archers' ? 5000 : 6000;
        if ((b.type === 'barracks' || b.type === 'archers') && Date.now() - b.lastSpawn > spawnCD) {
            let uType = b.type === 'archers' ? 'archer' : 'knight';
            gameState.units.push({ player: b.player, type: uType, x: b.x + 20, y: b.y + 20, hp: uType === 'archer' ? 50 : 100, maxHp: uType === 'archer' ? 50 : 100, speed: b.player === 1 ? -0.9 : 0.9, lastShot: 0 });
            b.lastSpawn = Date.now();
        }
        let shotCD = b.type === 'bomb' ? 3800 : 1500;
        if ((b.type === 'turret' || b.type === 'bomb') && Date.now() - b.lastShot > shotCD) {
            let target = gameState.units.find(u => u.player !== b.player && Math.hypot(u.x - b.x, u.y - b.y) < ATTACK_RANGE);
            if (target) { gameState.projectiles.push({ x: b.x+20, y: b.y+20, target, type: b.type, player: b.player }); b.lastShot = Date.now(); }
        }
        if (b.hp <= 0) gameState.buildings.splice(bi, 1);
    });

    // –õ–æ–≥–∏–∫–∞ —Å–Ω–∞—Ä—è–¥–æ–≤
    gameState.projectiles.forEach((p, pi) => {
        let dx = p.target.x - p.x, dy = p.target.y - p.y, dist = Math.hypot(dx, dy);
        if (dist < 10) {
            p.target.hp -= p.type === 'bomb' ? 70 : 30;
            gameState.projectiles.splice(pi, 1);
        } else { p.x += dx / dist * 7; p.y += dy / dist * 7; }
    });

    // –õ–æ–≥–∏–∫–∞ —é–Ω–∏—Ç–æ–≤ (–ë–æ–π –∏ –¥–≤–∏–∂–µ–Ω–∏–µ)
    gameState.units.forEach((u, i) => {
        let range = u.type === 'archer' ? 140 : 35;
        let target = null, minDist = 200;
        gameState.buildings.concat(gameState.units).forEach(obj => {
            if (obj.player !== u.player && obj !== u) {
                let d = Math.hypot(obj.x - u.x, obj.y - u.y);
                if (d < minDist) { minDist = d; target = obj; }
            }
        });

        if (target && minDist < range) {
            if (u.type === 'archer') {
                if (Date.now() - u.lastShot > 1500) { gameState.projectiles.push({ x: u.x, y: u.y, target, type: 'arrow', player: u.player }); u.lastShot = Date.now(); }
            } else { target.hp -= 1.3; }
        } else { u.y += u.speed; }

        if (u.y < 60 && u.player === 1) { gameState.p2.hp -= 20; u.hp = 0; }
        if (u.y > canvas.height - 60 && u.player === 2) { gameState.p1.hp -= 20; u.hp = 0; }
        if (u.hp <= 0) gameState.units.splice(i, 1);
    });

    draw();
    requestAnimationFrame(update);
}

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight * 2.5; }

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#355e3b"; ctx.fillRect(0,0, canvas.width, canvas.height);
    ctx.fillStyle = "rgba(255,255,255,0.1)"; ctx.fillRect(0, canvas.height/2-2, canvas.width, 4);
    
    // –ë–∞–∑—ã
    ctx.fillStyle = "#ff4444"; ctx.fillRect(0, 0, canvas.width, 60); 
    ctx.fillStyle = "#4444ff"; ctx.fillRect(0, canvas.height - 60, canvas.width, 60);

    gameState.buildings.forEach(b => {
        ctx.fillStyle = b.player === 1 ? "#3b44cc" : "#cc3b3b";
        ctx.fillRect(b.x, b.y, b.type === 'wall' ? 80 : 40, 40);
        ctx.fillStyle = "black"; ctx.fillRect(b.x, b.y-10, 40, 5);
        ctx.fillStyle = "lime"; ctx.fillRect(b.x, b.y-10, (b.hp/b.maxHp)*40, 5);
    });

    gameState.units.forEach(u => {
        ctx.fillStyle = u.player === 1 ? "#4444ff" : "#ff4444";
        ctx.beginPath(); ctx.arc(u.x, u.y, u.type === 'archer' ? 10 : 14, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "red"; ctx.fillRect(u.x-10, u.y-20, 20, 3);
        ctx.fillStyle = "lime"; ctx.fillRect(u.x-10, u.y-20, (u.hp/u.maxHp)*20, 3);
    });

    gameState.projectiles.forEach(p => {
        ctx.fillStyle = p.type === 'bomb' ? "yellow" : "white";
        ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
    });
}
</script>
</body>
</html>
