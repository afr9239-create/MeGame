<!DOCTYPE html>
<html>
<head>
    <title>War Castle Multiplayer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #lobby { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #game-container { width: 100vw; height: 100vh; overflow: hidden; position: relative; display: none; }
        canvas { display: block; background: #355e3b; }
        
        /* UI Styles */
        #ui { position: fixed; bottom: 10px; left: 0; width: 100%; display: flex; justify-content: center; gap: 6px; z-index: 10; }
        .shop-item { background: rgba(30,30,30,0.95); border: 2px solid #4444ff; width: 55px; height: 65px; text-align: center; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .stats { position: fixed; top: 5px; width: 100%; display: flex; justify-content: space-between; padding: 0 10px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .stat-card { background: rgba(0,0,0,0.7); padding: 6px 12px; border-radius: 8px; font-size: 11px; border-left: 4px solid #4444ff; }
        #status-text { margin-bottom: 20px; font-size: 1.2em; color: #ff00ff; }
        button { padding: 15px 30px; font-size: 18px; background: #4444ff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="lobby">
    <div id="status-text">War Castle: Walls Tactical</div>
    <button onclick="connectToServer()">ĞĞĞ™Ğ¢Ğ˜ Ğ˜Ğ“Ğ Ğ£ (PvP)</button>
</div>

<div class="stats">
    <div class="stat-card">ğŸ’°<span id="gold1">0</span> | ğŸ° <span id="hp1">500</span></div>
    <div class="stat-card" style="border-left:0; border-right:4px solid red; text-align:right;">ğŸ° <span id="hp2">500</span> | ğŸ’°<span id="gold2">0</span></div>
</div>

<div id="ui">
    <div class="shop-item" ontouchstart="startDrag('barracks', 50)">ğŸ <div style="color:gold; font-size:10px">50</div></div>
    <div class="shop-item" ontouchstart="startDrag('archers', 150)">ğŸ¹<div style="color:gold; font-size:10px">150</div></div>
    <div class="shop-item" ontouchstart="startDrag('wall', 200)">ğŸ§±<div style="color:gold; font-size:10px">200</div></div>
    <div class="shop-item" ontouchstart="startDrag('turret', 70)">ğŸ›¡ï¸<div style="color:gold; font-size:10px">70</div></div>
    <div class="shop-item" ontouchstart="startDrag('mine', 100)">ğŸ’<div id="mine-cost-ui" style="color:gold; font-size:10px">100</div></div>
</div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let socket;
let playerRole = null; // 1 - ÑĞ½Ğ¸Ğ·Ñƒ, 2 - ÑĞ²ĞµÑ€Ñ…Ñƒ
let currentRoom = null;

let gameState = {
    p1: { gold: 100, hp: 500, income: 3, mines: 0 },
    p2: { gold: 100, hp: 500, income: 3, mines: 0 },
    units: [], buildings: [], projectiles: []
};

// --- Ğ¡Ğ•Ğ¢Ğ•Ğ’ĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ ---
function connectToServer() {
    document.getElementById('status-text').innerText = "ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ½Ğ¸ĞºĞ°...";
    // Ğ—ĞĞœĞ•ĞĞ˜ ĞĞ Ğ¡Ğ’ĞĞ™ URL ĞĞ¢ RENDER
    socket = io("https://your-app-name.onrender.com"); 

    socket.emit('findGame');

    socket.on('startGame', (data) => {
        playerRole = data.role;
        currentRoom = data.room;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        initGame();
    });

    socket.on('syncBuilding', (data) => {
        // Ğ—ĞµÑ€ĞºĞ°Ğ»Ğ¸Ğ¼ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ²Ñ€Ğ°Ğ³Ğ°
        let realX = canvas.width - data.x - (data.type === 'wall' ? 80 : 40);
        let realY = canvas.height - data.y - (data.type === 'wall' ? 15 : 40);
        
        addBuilding(data.type, data.role, realX, realY, false);
    });
}

function initGame() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    requestAnimationFrame(update);
}

// --- Ğ˜Ğ“Ğ ĞĞ’ĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ ---
let dragging = null;
function startDrag(type, cost) {
    let actualCost = type === 'mine' ? 100 + (gameState['p'+playerRole].mines * 100) : cost;
    if (gameState['p'+playerRole].gold >= actualCost) {
        dragging = { type, cost: actualCost };
    }
}

window.addEventListener('touchend', (e) => {
    if (!dragging || !playerRole) return;
    let touch = e.changedTouches[0];
    let x = touch.clientX;
    let y = touch.clientY;

    // ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ: Ğ½ĞµĞ»ÑŒĞ·Ñ ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğ¾Ğ²Ğ¸Ğ½Ğµ Ğ²Ñ€Ğ°Ğ³Ğ°
    if (y > canvas.height / 2) {
        addBuilding(dragging.type, playerRole, x, y, true);
        gameState['p'+playerRole].gold -= dragging.cost;
        
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²Ñ€Ğ°Ğ³Ñƒ
        socket.emit('placeBuilding', {
            type: dragging.type,
            x: x, 
            y: y,
            role: playerRole,
            room: currentRoom
        });
    }
    dragging = null;
});

function addBuilding(type, player, x, y, isLocal) {
    let hp = (type === 'wall') ? 900 : 400;
    gameState.buildings.push({
        type, player, x, y, hp, maxHp: hp, lastSpawn: Date.now()
    });
    if (type === 'mine') gameState['p'+player].mines++;
}

function update() {
    // Ğ”Ğ¾Ñ…Ğ¾Ğ´
    gameState.p1.gold += (3 + gameState.p1.mines * 4) / 60;
    gameState.p2.gold += (3 + gameState.p2.mines * 4) / 60;

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ UI
    document.getElementById('gold1').innerText = Math.floor(gameState.p1.gold);
    document.getElementById('gold2').innerText = Math.floor(gameState.p2.gold);

    // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞ¿Ğ°Ğ²Ğ½Ğ° ÑĞ½Ğ¸Ñ‚Ğ¾Ğ² (ÑƒĞ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¼ÑƒĞ»ÑŒÑ‚Ğ¸Ğ¿Ğ»ĞµĞµÑ€Ğ°)
    gameState.buildings.forEach(b => {
        if ((b.type === 'barracks' || b.type === 'archers') && Date.now() - b.lastSpawn > 5000) {
            gameState.units.push({
                player: b.player,
                x: b.x + 20,
                y: b.y,
                hp: 100,
                speed: b.player === playerRole ? -1 : 1 // Ğ’Ñ€Ğ°Ğ³Ğ¸ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¸Ğ´ÑƒÑ‚ Ğ²Ğ½Ğ¸Ğ·
            });
            b.lastSpawn = Date.now();
        }
    });

    // Ğ”Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ ÑĞ½Ğ¸Ñ‚Ğ¾Ğ²
    gameState.units.forEach((u, i) => {
        u.y += u.speed;
        if (u.y < 0 || u.y > canvas.height) gameState.units.splice(i, 1);
    });

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Ğ›Ğ¸Ğ½Ğ¸Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ
    ctx.strokeStyle = "white";
    ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();

    // Ğ Ğ¸ÑÑƒĞµĞ¼ Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ
    gameState.buildings.forEach(b => {
        ctx.fillStyle = b.player === playerRole ? "blue" : "red";
        let w = b.type === 'wall' ? 80 : 40;
        let h = b.type === 'wall' ? 15 : 40;
        ctx.fillRect(b.x, b.y, w, h);
    });

    // Ğ Ğ¸ÑÑƒĞµĞ¼ ÑĞ½Ğ¸Ñ‚Ğ¾Ğ²
    gameState.units.forEach(u => {
        ctx.fillStyle = u.player === playerRole ? "cyan" : "orange";
        ctx.beginPath(); ctx.arc(u.x, u.y, 10, 0, Math.PI*2); ctx.fill();
    });
}
</script>
</body>
</html>
