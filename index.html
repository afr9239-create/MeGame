<!DOCTYPE html>
<html>
<head>
    <title>War Castle: Grand Arena</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; font-family: 'Verdana', sans-serif; touch-action: none; }
        canvas { display: block; }

        /* –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ */
        #loading-screen {
            position: fixed; inset: 0; background: #0a0a0a; color: #4caf50;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .spinner { width: 60px; height: 60px; border: 4px solid #1a1a1a; border-top: 4px solid #4caf50; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å */
        #inventory {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; background: rgba(10,10,10,0.9); padding: 12px 25px; 
            border-radius: 15px; border: 1px solid #333; z-index: 100; pointer-events: none;
        }
        .inv-slot { display: flex; align-items: center; gap: 10px; color: white; font-size: 20px; font-weight: bold; }

        /* –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞ –∫—Ä—É–≥–ª–∞—è */
        #minimap-wrapper {
            position: fixed; top: 20px; right: 20px; width: 140px; height: 140px;
            border-radius: 50%; border: 2px solid #555; overflow: hidden; background: rgba(0,0,0,0.8);
        }
        #minimap { width: 100%; height: 100%; }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        #joystick-ui {
            position: fixed; bottom: 50px; left: 50px; width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.05); border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
        }
        #knob { position: absolute; top: 40px; left: 40px; width: 40px; height: 40px; background: white; border-radius: 50%; }

        #attack-btn {
            position: fixed; bottom: 50px; right: 50px; width: 110px; height: 110px;
            background: #b71c1c; border: 4px solid #fff; border-radius: 50%;
            color: white; font-weight: bold; display: flex; align-items: center; justify-content: center;
            user-select: none; z-index: 11; font-size: 20px;
        }

        #fs-btn {
            position: fixed; bottom: 180px; right: 60px; width: 50px; height: 50px;
            background: rgba(255,255,255,0.1); border: 1px solid white; border-radius: 10px;
            color: white; display: flex; align-items: center; justify-content: center; font-size: 24px;
        }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="spinner"></div>
    <p>WAR CASTLE: –ü–û–î–ì–û–¢–û–í–ö–ê –ö–ê–†–¢–´...</p>
</div>

<div id="inventory">
    <div class="inv-slot">ü™µ <span id="inv-wood">0</span></div>
    <div class="inv-slot">ü™® <span id="inv-stone">0</span></div>
</div>

<div id="fs-btn">‚õ∂</div>
<div id="minimap-wrapper"><canvas id="minimap"></canvas></div>
<div id="joystick-ui"><div id="knob"></div></div>
<div id="attack-btn">–£–î–ê–†</div>
<canvas id="gameCanvas"></canvas>

<script>
const socket = io("https://war-castle.onrender.com"); 
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const mCanvas = document.getElementById("minimap");
const mCtx = mCanvas.getContext("2d");

// –ù–ê–°–¢–†–û–ô–ö–ò
const WORLD_SIZE = 7000; // –û–≥—Ä–æ–º–Ω–∞—è –∫–∞—Ä—Ç–∞
const speed = 9; // –í—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –±–µ–∑ —Å–∫–æ–ª—å–∂–µ–Ω–∏—è
let players = {};
let renderPlayers = {};
let staticObjects = [];
let deco = [];

const myColor = `hsl(${Math.random()*360}, 80%, 50%)`;
const myStroke = `hsl(${Math.random()*360}, 90%, 15%)`;

let myPos = { 
    x: 0, y: 0, 
    angle: 0, hp: 100, atk: false, atkP: 0,
    color: myColor, stroke: myStroke
};

let inventory = { wood: 0, stone: 0 };
let moveDir = { x: 0, y: 0 };

// –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–ò–Ø–¢–ù–û–ô –ö–ê–†–¢–´
function initWorld() {
    // –û—á–µ–Ω—å —Ä–µ–¥–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã (12 —à—Ç—É–∫ –Ω–∞ –≤—Å—é –∫–∞—Ä—Ç—É)
    for(let i=0; i<12; i++) {
        staticObjects.push({
            x: (Math.random()-0.5)*(WORLD_SIZE-1000),
            y: (Math.random()-0.5)*(WORLD_SIZE-1000),
            type: Math.random() > 0.5 ? 'tree' : 'stone',
            size: 120 + Math.random()*50
        });
    }
    // –§–æ–Ω–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏ (—Ç—Ä–∞–≤–∞ –∏ –∫–æ—á–∫–∏)
    for(let i=0; i<800; i++) {
        deco.push({
            x: (Math.random()-0.5)*WORLD_SIZE,
            y: (Math.random()-0.5)*WORLD_SIZE,
            type: Math.random() > 0.7 ? 'rock' : 'grass',
            size: 10 + Math.random()*20
        });
    }
}
initWorld();

function safeSpawn() {
    myPos.x = (Math.random()-0.5)*3000;
    myPos.y = (Math.random()-0.5)*3000;
    staticObjects.forEach(obj => {
        if(Math.sqrt((obj.x-myPos.x)**2 + (obj.y-myPos.y)**2) < obj.size + 150) safeSpawn();
    });
}
safeSpawn();

socket.on('connect', () => { document.getElementById('loading-screen').remove(); });
socket.on('update', (sP) => {
    players = sP;
    for(let id in players) if(!renderPlayers[id]) renderPlayers[id] = {...players[id]};
});

// –£–ü–†–ê–í–õ–ï–ù–ò–ï (–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫)
const joy = document.getElementById("joystick-ui");
const knob = document.getElementById("knob");
let joyId = null;

window.addEventListener('touchstart', (e) => {
    for(let t of e.changedTouches) {
        let r = joy.getBoundingClientRect();
        if(t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) joyId = t.identifier;
    }
});

window.addEventListener('touchmove', (e) => {
    for(let t of e.touches) if(t.identifier === joyId) {
        let r = joy.getBoundingClientRect();
        let dx = t.clientX - (r.left + 60), dy = t.clientY - (r.top + 60);
        let d = Math.sqrt(dx*dx + dy*dy);
        if(d > 50) { dx *= 50/d; dy *= 50/d; }
        knob.style.transform = `translate(${dx}px, ${dy}px)`;
        moveDir = { x: dx/50, y: dy/50 };
        myPos.angle = Math.atan2(dy, dx);
    }
}, {passive: false});

window.addEventListener('touchend', (e) => {
    for(let t of e.changedTouches) if(t.identifier === joyId) {
        joyId = null; knob.style.transform = `translate(0,0)`; moveDir = { x: 0, y: 0 };
    }
});

document.getElementById('fs-btn').onclick = () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
};

const atkBtn = document.getElementById("attack-btn");
atkBtn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (!myPos.atk) { myPos.atk = true; myPos.atkP = -0.8; }
});

function checkHit() {
    staticObjects.forEach(obj => {
        let d = Math.sqrt((obj.x-myPos.x)**2 + (obj.y-myPos.y)**2);
        if (d < obj.size + 130) {
            if (obj.type === 'tree') inventory.wood++; else inventory.stone++;
            document.getElementById('inv-wood').innerText = inventory.wood;
            document.getElementById('inv-stone').innerText = inventory.stone;
        }
    });
}

function update() {
    // –ü–†–Ø–ú–û–ï –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï –ë–ï–ó –°–ö–û–õ–¨–ñ–ï–ù–ò–Ø
    let nx = myPos.x + moveDir.x * speed;
    let ny = myPos.y + moveDir.y * speed;

    // –ö–æ–ª–ª–∏–∑–∏—è —Å –æ–±—ä–µ–∫—Ç–∞–º–∏
    let canMove = true;
    staticObjects.forEach(obj => {
        if(Math.sqrt((obj.x-nx)**2 + (obj.y-ny)**2) < obj.size + 60) canMove = false;
    });

    if(canMove) {
        if (Math.abs(nx) < WORLD_SIZE/2 - 100) myPos.x = nx;
        if (Math.abs(ny) < WORLD_SIZE/2 - 100) myPos.y = ny;
    }

    if (myPos.atk) {
        myPos.atkP += 0.12;
        if (myPos.atkP >= 0.3 && myPos.atkP <= 0.45) checkHit();
        if (myPos.atkP > 1.5) { myPos.atk = false; myPos.atkP = 0; }
    }

    // –ü–ª–∞–≤–Ω–æ—Å—Ç—å –≤—Ä–∞–≥–æ–≤ (–∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è)
    for (let id in renderPlayers) {
        if (players[id]) {
            let p = players[id], rp = renderPlayers[id];
            rp.x += (p.x - rp.x) * 0.25;
            rp.y += (p.y - rp.y) * 0.25;
            rp.angle += (p.angle - rp.angle) * 0.25;
            rp.atk = p.atk; rp.atkP = p.atkP;
            rp.color = p.color; rp.stroke = p.stroke;
        } else delete renderPlayers[id];
    }

    socket.emit('move', { x: myPos.x, y: myPos.y, angle: myPos.angle, atk: myPos.atk, atkP: myPos.atkP, color: myPos.color, stroke: myPos.stroke });
    draw();
    requestAnimationFrame(update);
}

function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    ctx.fillStyle = "#050505"; ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    // –ö–ê–ú–ï–†–ê –°–¢–ê–ë–ò–õ–¨–ù–ê–Ø (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏)
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(0.25, 0.25); // –ï—â–µ –≤—ã—à–µ –≤ –Ω–µ–±–æ
    ctx.translate(-myPos.x, -myPos.y);

    // –¢–ï–ö–°–¢–£–†–ê –ó–ï–ú–õ–ò
    ctx.fillStyle = "#1b2b1b"; // –ì–ª—É–±–æ–∫–∏–π –ª–µ—Å–Ω–æ–π —Ü–≤–µ—Ç
    ctx.fillRect(-WORLD_SIZE/2, -WORLD_SIZE/2, WORLD_SIZE, WORLD_SIZE);
    
    // –¢–µ–∫—Å—Ç—É—Ä–Ω—ã–π —à—É–º (–ø—è—Ç–Ω–∞ –∑–µ–º–ª–∏)
    ctx.fillStyle = "#162416";
    for(let i=0; i<200; i++) {
        ctx.beginPath();
        ctx.arc((i*777)%WORLD_SIZE - WORLD_SIZE/2, (i*123)%WORLD_SIZE - WORLD_SIZE/2, 300, 0, Math.PI*2);
        ctx.fill();
    }

    // –î–µ–∫–æ—Ä
    deco.forEach(d => {
        ctx.fillStyle = d.type === 'grass' ? "#2d4a2d" : "#333";
        ctx.fillRect(d.x, d.y, d.size, d.size);
    });

    // –†–µ—Å—É—Ä—Å—ã
    staticObjects.forEach(obj => {
        ctx.fillStyle = obj.type === 'tree' ? "#0a330a" : "#444";
        ctx.beginPath(); ctx.arc(obj.x, obj.y, obj.size, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "rgba(0,0,0,0.5)"; ctx.lineWidth = 15; ctx.stroke();
    });

    for(let id in renderPlayers) drawPlayer(renderPlayers[id], id === socket.id);

    ctx.restore();
    drawMinimap();
}

function drawPlayer(p, isMe) {
    ctx.save();
    ctx.translate(p.x, p.y);
    
    // HP
    ctx.fillStyle = "black"; ctx.fillRect(-80, -140, 160, 20);
    ctx.fillStyle = "#4caf50"; ctx.fillRect(-80, -140, (p.hp/100)*160, 20);

    ctx.rotate(p.angle);
    
    // –ö–†–£–¢–û–ô –ú–û–õ–û–¢
    ctx.save();
    let r = 0, off = 0;
    if(p.atk) {
        if(p.atkP < 0) r = p.atkP * 1.5;
        else { r = Math.sin(p.atkP * Math.PI) * 2; off = Math.sin(p.atkP * Math.PI) * 50; }
    }
    ctx.rotate(r);
    // –†—É–∫–æ—è—Ç—å
    ctx.fillStyle = "#4e342e";
    ctx.fillRect(off + 15, -100, 30, 200); 
    // –ë–æ–µ–∫
    ctx.fillStyle = "#212121";
    ctx.fillRect(off - 30, -110, 120, 70);
    ctx.fillRect(off - 30, 40, 120, 70);
    ctx.restore();

    // –¢–µ–ª–æ
    ctx.fillStyle = p.color;
    ctx.beginPath(); ctx.arc(0, 0, 85, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = p.stroke; ctx.lineWidth = 15; ctx.stroke();
    
    // –†—É–∫–∏
    ctx.beginPath(); ctx.arc(70, -50, 30, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(70, 50, 30, 0, Math.PI*2); ctx.fill(); ctx.stroke();

    ctx.restore();
}

function drawMinimap() {
    mCanvas.width = 140; mCanvas.height = 140;
    mCtx.fillStyle = "rgba(0,0,0,0.8)"; mCtx.beginPath(); mCtx.arc(70, 70, 70, 0, Math.PI*2); mCtx.fill();
    for(let id in players) {
        let p = players[id];
        let mx = ((p.x + WORLD_SIZE/2) / WORLD_SIZE) * 140, my = ((p.y + WORLD_SIZE/2) / WORLD_SIZE) * 140;
        mCtx.fillStyle = (id === socket.id) ? "white" : "red";
        mCtx.beginPath(); mCtx.arc(mx, my, 5, 0, Math.PI*2); mCtx.fill();
    }
}
update();
</script>
</body>
</html>
