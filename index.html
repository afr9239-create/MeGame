<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fantasy Duel: High Quality</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a2b1a; font-family: 'Segoe UI', sans-serif; user-select: none; color: white; }
        canvas { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; touch-action: none; }
        
        .hp-container { position: absolute; width: 140px; height: 16px; background: rgba(0,0,0,0.6); border: 2px solid #fff; border-radius: 10px; overflow: hidden; z-index: 10; display: none; }
        .hp-bar { width: 100%; height: 100%; transition: width 0.3s ease; }
        #ui-blue { top: 20px; left: 20px; } #hp-blue { background: #00d2ff; }
        #ui-red { top: 20px; right: 20px; } #hp-red { background: #ff4757; }
        .mana-display { position: absolute; bottom: 25px; left: 25px; background: rgba(0, 30, 80, 0.85); padding: 12px 20px; border-radius: 30px; font-weight: bold; border: 2px solid #fff; z-index: 10; display: none; }
        #shop { position: absolute; right: 25px; bottom: 25px; z-index: 11; display: none; }
        .card { width: 80px; height: 80px; background: #5d4037; border: 4px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; }
        .btn { padding: 15px 35px; margin: 10px; font-size: 1.2rem; background: #2ecc71; color: white; border: none; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div id="ui-blue" class="hp-container"><div id="hp-blue" class="hp-bar"></div></div>
<div id="ui-red" class="hp-container"><div id="hp-red" class="hp-bar"></div></div>
<div id="mana-box" class="mana-display">MANA: <span id="mana">500</span></div>
<div id="shop"><div class="card" onclick="spawnUnitNet()"><b>DEPLOY</b></div></div>

<div id="game-menu" class="overlay">
    <h1>FANTASY DUEL</h1>
    <p id="player-count">Подключение...</p>
    <p id="my-role"></p>
    <button id="start-btn" class="btn" onclick="requestStart()" disabled>ОЖИДАНИЕ</button>
</div>

<canvas id="game"></canvas>

<script>
    const socket = io('https://megame-server.onrender.com', { transports: ['websocket'] });
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    let mySide = null;
    let gameState = 'MENU';
    let pBlue = { hp: 100, money: 500 }, pRed = { hp: 100, money: 500 };  
    let units = [];
    let cameraY = 0;
    const roadLength = 3000; 

    const mapImg = new Image(); mapImg.src = 'map.jpg'; 
    const bazaImg = new Image(); bazaImg.src = 'baza.jpg';

    socket.on('playerRole', (role) => {
        mySide = role;
        document.getElementById('my-role').innerText = "Ты: " + (role === 1 ? "КРАСНЫЙ" : "СИНИЙ");
    });

    socket.on('playerCount', (count) => {
        document.getElementById('player-count').innerText = "Игроков: " + count + "/2";
        const btn = document.getElementById('start-btn');
        if (count >= 2 && mySide === 2) {
            btn.disabled = false;
            btn.innerText = "НАЧАТЬ ИГРУ";
        }
    });

    socket.on('gameStart', () => {
        gameState = 'PLAYING';
        document.getElementById('game-menu').style.display = 'none';
        document.querySelectorAll('.hp-container, .mana-display, #shop').forEach(el => el.style.display = 'block');
    });

    socket.on('spawnUnit', (data) => {
        units.push({ ...data, id: Math.random(), currentHp: 100 });
    });

    function requestStart() { socket.emit('startGame'); }

    function spawnUnitNet() {
        let money = (mySide === 2) ? pBlue.money : pRed.money;
        if (money >= 50 && gameState === 'PLAYING') {
            if(mySide === 2) pBlue.money -= 50; else pRed.money -= 50;
            
            // Центрируем дорогу
            let roadWidth = 800; 
            let roadX = (window.innerWidth / 2) - (roadWidth / 2);
            let spawnX = roadX + 100 + Math.random() * (roadWidth - 200);
            
            let unitData = {
                x: spawnX,
                y: (mySide === 1) ? -roadLength + 250 : roadLength - 250,
                side: mySide,
                color: (mySide === 1) ? '#ff4757' : '#00d2ff'
            };
            socket.emit('spawnUnit', unitData);
            units.push({...unitData, id: Math.random(), currentHp: 100});
            updateUI();
        }
    }

    function updateUI() {
        document.getElementById('mana').innerText = Math.floor((mySide === 2) ? pBlue.money : pRed.money);
        document.getElementById('hp-blue').style.width = pBlue.hp + '%';
        document.getElementById('hp-red').style.width = pRed.hp + '%';
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(0, cameraY + (window.innerHeight/2)); // Камера центрируется

        let sw = window.innerWidth;
        let roadWidth = 800; 
        let roadX = (sw / 2) - (roadWidth / 2);

        // ТРАВА
        ctx.fillStyle = '#1a2b1a';
        ctx.fillRect(-2000, -roadLength - 1000, 4000, roadLength * 3);

        // ДОРОГА (Рисуем КРАСИВО и ЧЕТКО)
        if (mapImg.complete) {
            // Рисуем дорогу от начала до конца без искажений
            for (let y = -roadLength; y < roadLength; y += mapImg.height) {
                ctx.drawImage(mapImg, roadX, y, roadWidth, mapImg.height);
            }
        }

        // БАЗЫ
        if (bazaImg.complete) {
            ctx.drawImage(bazaImg, roadX, -roadLength - 150, roadWidth, 300); // Верхняя
            ctx.drawImage(bazaImg, roadX, roadLength - 150, roadWidth, 300); // Нижняя
        }

        // БОЙ И ДВИЖЕНИЕ
        units.forEach((u, i) => {
            let collision = false;
            units.forEach(other => {
                if (other.side !== u.side) {
                    let d = Math.hypot(u.x - other.x, u.y - other.y);
                    if (d < 40) { 
                        collision = true;
                        other.currentHp -= 0.4; // Взаимный урон
                    }
                }
            });

            if (!collision) {
                u.y += (u.side === 1) ? 2.5 : -2.5;
            }

            // Рисование юнита
            ctx.fillStyle = u.color;
            ctx.beginPath(); ctx.arc(u.x, u.y, 18, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.stroke();
            
            // Полоска жизни над юнитом
            ctx.fillStyle = "black"; ctx.fillRect(u.x - 20, u.y - 35, 40, 6);
            ctx.fillStyle = "#00ff00"; ctx.fillRect(u.x - 20, u.y - 35, 40 * (u.currentHp/100), 6);

            // Урон базе
            if (u.side === 2 && u.y < -roadLength + 100) { pRed.hp -= 5; units.splice(i, 1); }
            if (u.side === 1 && u.y > roadLength - 100) { pBlue.hp -= 5; units.splice(i, 1); }
            
            if (u.currentHp <= 0) units.splice(i, 1);
        });

        ctx.restore();
        
        // Конец игры
        if (pBlue.hp <= 0) { alert("ПОРАЖЕНИЕ!"); location.reload(); }
        if (pRed.hp <= 0) { alert("ПОБЕДА!"); location.reload(); }

        requestAnimationFrame(draw);
    }

    // Управление камерой (плавное)
    let isDragging = false, startY = 0;
    canvas.addEventListener('touchstart', e => { isDragging = true; startY = e.touches[0].clientY - cameraY; });
    window.addEventListener('touchmove', e => {
        if(isDragging) {
            cameraY = e.touches[0].clientY - startY;
            e.preventDefault();
        }
    }, {passive: false});
    window.addEventListener('touchend', () => isDragging = false);

    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    setInterval(() => { if(gameState === 'PLAYING') { pBlue.money += 10; pRed.money += 10; updateUI(); }}, 1000);
    draw();
</script>
</body>
