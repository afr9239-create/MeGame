<!DOCTYPE html>
<html>
<head>
    <title>War Castle: Arena PVP FULL VERSION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; touch-action: none; }
        #game-container { width: 100vw; height: 100vh; overflow-y: auto; overflow-x: hidden; position: relative; scrollbar-width: none; display: none; }
        #game-container::-webkit-scrollbar { display: none; }
        canvas { display: block; background: #355e3b; width: 100%; height: auto; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* –ú–ï–ù–Æ */
        #menu-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #2c3e50 0%, #000 100%); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .menu-card { background: rgba(0,0,0,0.6); padding: 50px; border-radius: 30px; border: 2px solid #ff00ff; text-align: center; backdrop-filter: blur(10px); }
        .btn-battle { background: linear-gradient(135deg, #ff00ff 0%, #800080 100%); border: none; color: white; padding: 20px 60px; font-size: 28px; font-weight: bold; border-radius: 50px; cursor: pointer; transition: 0.3s; box-shadow: 0 0 30px rgba(255,0,255,0.5); }
        .btn-battle:hover { transform: scale(1.05); }
        .searching-text { color: #00ffff; margin-top: 25px; display: none; font-size: 18px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
        
        /* –ò–ù–¢–ï–†–§–ï–ô–° –ò–ì–†–´ */
        #ui { position: fixed; bottom: 15px; left: 0; width: 100%; display: none; justify-content: center; gap: 8px; z-index: 10; }
        .shop-item { 
            background: rgba(20, 20, 20, 0.9); border: 2px solid #4444ff; width: 60px; height: 75px; 
            text-align: center; border-radius: 12px; font-size: 11px; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .shop-item:active { transform: translateY(-5px); border-color: #ff00ff; }
        .item-icon { font-size: 24px; margin-bottom: 3px; }

        .stats { position: fixed; top: 10px; width: 100%; display: none; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .stat-card { background: rgba(0,0,0,0.8); padding: 10px 18px; border-radius: 12px; font-size: 13px; border-left: 5px solid #4444ff; backdrop-filter: blur(5px); }
        .red-side { border-left: 0; border-right: 5px solid #ff4444; text-align: right; }
        
        #drag-icon { position: fixed; width: 45px; height: 45px; background: rgba(255,255,255,0.3); border: 3px solid #fff; display: none; pointer-events: none; transform: translate(-50%, -50%); z-index: 100; text-align: center; line-height: 45px; font-size: 28px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="menu-screen">
    <div class="menu-card">
        <h1 style="font-size: 48px; margin: 0; letter-spacing: 5px; text-shadow: 0 0 20px #ff00ff;">WAR CASTLE</h1>
        <p style="color: #aaa; margin-bottom: 40px;">MULTIPLAYER ARENA</p>
        <button class="btn-battle" onclick="findMatch()">–í –ë–û–ô</button>
        <div id="search-status" class="searching-text">–ò–©–ï–ú –°–û–ü–ï–†–ù–ò–ö–ê –î–õ–Ø –ë–ò–¢–í–´...</div>
        <p id="online-count" style="margin-top: 20px; color: #555;">–°–µ—Ä–≤–µ—Ä: –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...</p>
    </div>
</div>

<div class="stats" id="stats-ui">
    <div class="stat-card">
        üí∞ <span id="gold1">0</span><br>
        üè∞ <span id="hp1">500</span> | üíé <span id="mines1">0</span>/3
    </div>
    <div class="stat-card red-side">
        üí∞ <span id="gold2">0</span><br>
        <span id="mines2">0</span>/3 | üè∞ <span id="hp2">500</span>
    </div>
</div>

<div id="ui">
    <div class="shop-item" ontouchstart="startDrag('barracks', 50)"><div class="item-icon">üè†</div>50</div>
    <div class="shop-item" ontouchstart="startDrag('archers', 150)"><div class="item-icon">üèπ</div>150</div>
    <div class="shop-item" ontouchstart="startDrag('wall', 200)"><div class="item-icon">üß±</div>200</div>
    <div class="shop-item" ontouchstart="startDrag('turret', 70)"><div class="item-icon">üõ°Ô∏è</div>70</div>
    <div class="shop-item" ontouchstart="startDrag('bomb', 200)"><div class="item-icon">üí£</div>200</div>
    <div class="shop-item" ontouchstart="startDrag('mine', 100)"><div class="item-icon">üíé</div><span id="mine-cost-ui">100</span></div>
</div>

<div id="drag-icon"></div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
</div>

<script>
const socket = io("https://war-castle.onrender.com");
let gameStarted = false;
let isSearching = false;
const ATTACK_RANGE = 320;
const decorations = [];

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const container = document.getElementById("game-container");
const dragIcon = document.getElementById("drag-icon");

let gameState = {
    p1: { gold: 120, hp: 500, income: 3, mines: 0 }, 
    p2: { gold: 120, hp: 500, income: 3, mines: 0 }, 
    units: [], buildings: [], projectiles: [], vfx: []
};

// --- –°–ï–¢–ï–í–ê–Ø –ß–ê–°–¢–¨ ---
socket.on('playerUpdate', (count) => {
    document.getElementById('online-count').innerText = `–ò–ì–†–û–ö–û–í –í –°–ï–¢–ò: ${count}`;
});

function findMatch() {
    if (isSearching) return;
    isSearching = true;
    document.getElementById('search-status').style.display = 'block';
    socket.emit('findMatch'); 
}

socket.on('matchFound', () => {
    gameStarted = true;
    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('ui').style.display = 'flex';
    document.getElementById('stats-ui').style.display = 'flex';
    container.style.display = 'block';
    initGame();
});

socket.on('syncEnemyResources', (data) => {
    gameState.p2.gold = data.gold;
    gameState.p2.hp = data.hp;
    gameState.p2.mines = data.mines;
});

socket.on('enemySpawn', (data) => {
    let mirroredX = canvas.width - data.x - (data.type === 'wall' ? 80 : 40);
    let mirroredY = canvas.height - data.y - 40;
    let hp = data.type === 'wall' ? 1200 : 450;
    gameState.buildings.push({ type: data.type, player: 2, x: mirroredX, y: mirroredY, hp: hp, maxHp: hp, lastSpawn: Date.now(), lastShot: 0 });
    gameState.vfx.push({ x: mirroredX + 20, y: mirroredY + 20, time: Date.now(), type: 'spawn' });
});

// --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê (–ü–û–õ–ù–ê–Ø) ---
function initGame() {
    resize();
    for(let i=0; i<50; i++) {
        decorations.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: 2 + Math.random() * 6,
            type: Math.random() > 0.7 ? 'stone' : 'grass'
        });
    }
    setTimeout(() => container.scrollTop = canvas.height, 200);
    update();
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight * 2.5;
}

let dragging = null;
function startDrag(type, cost) {
    let actualCost = type === 'mine' ? 100 + (gameState.p1.mines * 100) : cost;
    if (gameState.p1.gold >= actualCost && (type !== 'mine' || gameState.p1.mines < 3)) {
        dragging = { type, cost: actualCost };
        dragIcon.style.display = "block";
        const icons = { barracks: 'üè†', archers: 'üèπ', wall: 'üß±', turret: 'üõ°Ô∏è', bomb: 'üí£', mine: 'üíé' };
        dragIcon.innerHTML = icons[type];
    }
}

window.addEventListener('touchmove', (e) => {
    if (dragging) {
        dragIcon.style.left = e.touches[0].clientX + "px";
        dragIcon.style.top = e.touches[0].clientY + "px";
    }
});

window.addEventListener('touchend', (e) => {
    if (!dragging) return;
    let touch = e.changedTouches[0], cY = touch.clientY + container.scrollTop, cX = touch.clientX;
    let w = dragging.type === 'wall' ? 80 : 40;

    if (cY > canvas.height / 2 && cY < canvas.height - 70) {
        gameState.p1.gold -= dragging.cost;
        socket.emit('spawnUnit', { type: dragging.type, x: cX - w/2, y: cY - 20 });
        if (dragging.type === 'mine') { gameState.p1.income += 4; gameState.p1.mines++; }
        let hp = dragging.type === 'wall' ? 1200 : 450;
        gameState.buildings.push({ type: dragging.type, player: 1, x: cX - w/2, y: cY - 20, hp: hp, maxHp: hp, lastSpawn: Date.now(), lastShot: 0 });
        gameState.vfx.push({ x: cX, y: cY, time: Date.now(), type: 'spawn' });
    }
    dragging = null; dragIcon.style.display = "none";
});

function update() {
    if(!gameStarted) return;

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    if (Math.floor(Date.now() / 1000) % 1 === 0) {
        socket.emit('syncResources', { gold: gameState.p1.gold, hp: gameState.p1.hp, mines: gameState.p1.mines });
    }

    gameState.p1.gold += gameState.p1.income / 60;
    
    document.getElementById("gold1").innerText = Math.floor(gameState.p1.gold);
    document.getElementById("gold2").innerText = Math.floor(gameState.p2.gold);
    document.getElementById("hp1").innerText = Math.floor(gameState.p1.hp);
    document.getElementById("hp2").innerText = Math.floor(gameState.p2.hp);
    document.getElementById("mines1").innerText = gameState.p1.mines;
    document.getElementById("mines2").innerText = gameState.p2.mines;

    // –õ–æ–≥–∏–∫–∞ –∑–¥–∞–Ω–∏–π
    gameState.buildings.forEach((b, bi) => {
        let spawnCD = b.type === 'archers' ? 5000 : 7000;
        if ((b.type === 'barracks' || b.type === 'archers') && Date.now() - b.lastSpawn > spawnCD) {
            let uType = b.type === 'archers' ? 'archer' : 'knight';
            gameState.units.push({ player: b.player, type: uType, x: b.x + 20, y: b.y + 20, hp: uType === 'archer' ? 60 : 120, maxHp: uType === 'archer' ? 60 : 120, speed: b.player === 1 ? -1.1 : 1.1, lastShot: 0 });
            b.lastSpawn = Date.now();
        }
        
        let shotCD = b.type === 'bomb' ? 3500 : 1400;
        if ((b.type === 'turret' || b.type === 'bomb') && Date.now() - b.lastShot > shotCD) {
            let target = gameState.units.find(u => u.player !== b.player && Math.hypot(u.x - b.x, u.y - b.y) < ATTACK_RANGE);
            if (target) {
                gameState.projectiles.push({ x: b.x+20, y: b.y+20, target: target, type: b.type, player: b.player });
                b.lastShot = Date.now();
            }
        }
        if (b.hp <= 0) {
            gameState.vfx.push({ x: b.x+20, y: b.y+20, time: Date.now(), type: 'death' });
            gameState.buildings.splice(bi, 1);
        }
    });

    // –õ–æ–≥–∏–∫–∞ —Å–Ω–∞—Ä—è–¥–æ–≤
    gameState.projectiles.forEach((p, pi) => {
        let dx = p.target.x - p.x, dy = p.target.y - p.y, dist = Math.hypot(dx, dy);
        if (dist < 10 || p.target.hp <= 0) {
            if (p.type === 'bomb') {
                gameState.vfx.push({ x: p.x, y: p.y, time: Date.now(), type: 'explosion' });
                gameState.units.forEach(u => { if(u.player !== p.player && Math.hypot(u.x - p.x, u.y - p.y) < 100) u.hp -= 80; });
            } else { p.target.hp -= 35; }
            gameState.projectiles.splice(pi, 1);
        } else { p.x += dx / dist * 8; p.y += dy / dist * 8; }
    });

    // –õ–æ–≥–∏–∫–∞ —é–Ω–∏—Ç–æ–≤
    gameState.units.forEach((u, i) => {
        let attackRange = u.type === 'archer' ? 150 : 40;
        let closest = null, minDist = 250;
        
        gameState.buildings.concat(gameState.units).forEach(obj => {
            if (obj.player !== u.player && obj !== u) {
                let d = Math.hypot(obj.x - u.x, obj.y - u.y);
                if (d < minDist) { minDist = d; closest = obj; }
            }
        });

        if (closest && minDist < attackRange) {
            if (u.type === 'archer') {
                if (Date.now() - u.lastShot > 1600) {
                    gameState.projectiles.push({ x: u.x, y: u.y, target: closest, type: 'arrow', player: u.player });
                    u.lastShot = Date.now();
                }
            } else { closest.hp -= 1.5; }
        } else { u.y += u.speed; }

        if (u.y < 60 && u.player === 1) { gameState.p2.hp -= 30; u.hp = 0; }
        if (u.y > canvas.height - 60 && u.player === 2) { gameState.p1.hp -= 30; u.hp = 0; }
        if (u.hp <= 0) gameState.units.splice(i, 1);
    });

    gameState.vfx = gameState.vfx.filter(v => Date.now() - v.time < 1000);

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // –¢—Ä–∞–≤–∞ –∏ –∫–∞–º–Ω–∏
    ctx.fillStyle = "#355e3b"; ctx.fillRect(0,0, canvas.width, canvas.height);
    decorations.forEach(d => {
        ctx.fillStyle = d.type === 'stone' ? "#777" : "#2d4d31";
        ctx.beginPath(); ctx.arc(d.x, d.y, d.size, 0, Math.PI*2); ctx.fill();
    });

    // –†–µ–∫–∞ / –¶–µ–Ω—Ç—Ä
    ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.fillRect(0, canvas.height/2 - 20, canvas.width, 40);
    ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 2; ctx.strokeRect(0, canvas.height/2 - 20, canvas.width, 40);
    
    // –ë–∞–∑—ã
    ctx.fillStyle = "#cc3b3b"; ctx.fillRect(0, 0, canvas.width, 65);
    ctx.fillStyle = "#3b44cc"; ctx.fillRect(0, canvas.height - 65, canvas.width, 65);

    // –ó–¥–∞–Ω–∏—è
    gameState.buildings.forEach(b => {
        let color = b.player === 1 ? "#4444ff" : "#ff4444";
        ctx.save();
        ctx.shadowBlur = 10; ctx.shadowColor = "black";
        if (b.type === 'barracks' || b.type === 'archers') {
            ctx.fillStyle = color; ctx.beginPath();
            ctx.moveTo(b.x, b.y+40); ctx.lineTo(b.x, b.y+15); ctx.lineTo(b.x+20, b.y); ctx.lineTo(b.x+40, b.y+15); ctx.lineTo(b.x+40, b.y+40); ctx.fill();
            ctx.fillStyle = "white"; ctx.font = "bold 10px Arial"; ctx.fillText(b.type==='archers'?'üèπ':'üè†', b.x+12, b.y+30);
        } else if (b.type === 'wall') {
            ctx.fillStyle = "#555"; ctx.fillRect(b.x, b.y, 80, 20); ctx.fillStyle = color; ctx.fillRect(b.x, b.y, 80, 5);
        } else if (b.type === 'mine') {
            ctx.fillStyle = "#ffd700"; ctx.beginPath(); ctx.arc(b.x+20, b.y+20, 18, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#000"; ctx.fillText("üíé", b.x+12, b.y+25);
        } else {
            ctx.fillStyle = "#333"; ctx.fillRect(b.x, b.y+20, 40, 20);
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(b.x+20, b.y+15, 15, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
        
        // HP Bar
        let bw = b.type === 'wall' ? 80 : 40;
        ctx.fillStyle = "black"; ctx.fillRect(b.x, b.y - 12, bw, 6);
        ctx.fillStyle = b.player === 1 ? "#5555ff" : "#ff5555"; ctx.fillRect(b.x, b.y - 12, (b.hp / b.maxHp) * bw, 6);
    });

    // –Æ–Ω–∏—Ç—ã
    gameState.units.forEach(u => {
        ctx.fillStyle = u.player === 1 ? "#4444ff" : "#ff4444";
        ctx.beginPath();
        if (u.type === 'archer') { ctx.arc(u.x, u.y, 11, 0, Math.PI*2); }
        else { ctx.arc(u.x, u.y, 15, 0, Math.PI*2); }
        ctx.fill(); ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
        
        // HP Unit
        ctx.fillStyle = "black"; ctx.fillRect(u.x-12, u.y-25, 24, 4);
        ctx.fillStyle = "#0f0"; ctx.fillRect(u.x-12, u.y-25, (u.hp / u.maxHp) * 24, 4);
    });

    // –°–Ω–∞—Ä—è–¥—ã –∏ VFX
    gameState.projectiles.forEach(p => {
        ctx.fillStyle = p.type === 'bomb' ? "#ff0" : (p.type==='arrow'?'#fff':'#fa0');
        ctx.beginPath(); ctx.arc(p.x, p.y, p.type==='bomb'?8:4, 0, Math.PI*2); ctx.fill();
    });
    
    gameState.vfx.forEach(v => {
        if(v.type === 'explosion') {
            ctx.fillStyle = "rgba(255, 100, 0, 0.5)"; ctx.beginPath(); ctx.arc(v.x, v.y, 100, 0, Math.PI*2); ctx.fill();
        }
    });
}
</script>
</body>
</html>
