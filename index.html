<!DOCTYPE html>
<html>
<head>
    <title>War Castle Multiplayer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #lobby { position: fixed; inset: 0; background: #222; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #game-container { width: 100vw; height: 100vh; display: none; position: relative; }
        canvas { display: block; background: #355e3b; }
        
        #status-text { font-size: 24px; margin-bottom: 10px; color: #4444ff; font-weight: bold; }
        #online-counter { color: #00ff00; margin-bottom: 30px; font-family: monospace; }
        
        button { padding: 15px 40px; font-size: 20px; background: #4444ff; color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 5px 0 #2222aa; }
        button:active { transform: translateY(3px); box-shadow: 0 2px 0 #2222aa; }
        button:disabled { background: #555; box-shadow: none; cursor: default; }

        .ui-panel { position: fixed; bottom: 10px; width: 100%; display: flex; justify-content: center; gap: 8px; pointer-events: none; }
        .shop-item { pointer-events: auto; background: rgba(0,0,0,0.8); border: 2px solid #4444ff; width: 60px; height: 70px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="lobby">
    <div id="status-text">WAR CASTLE</div>
    <div id="online-counter">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
    <button id="find-btn" onclick="requestMatch()">–í –ë–û–ô!</button>
</div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div class="ui-panel">
        <div class="shop-item" ontouchstart="startDrag('barracks', 50)">üè†<br><small>50</small></div>
        <div class="shop-item" ontouchstart="startDrag('archers', 150)">üèπ<br><small>150</small></div>
        <div class="shop-item" ontouchstart="startDrag('wall', 200)">üß±<br><small>200</small></div>
        <div class="shop-item" ontouchstart="startDrag('turret', 70)">üõ°Ô∏è<br><small>70</small></div>
        <div class="shop-item" ontouchstart="startDrag('mine', 100)">üíé<br><small>100</small></div>
    </div>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let socket;
let playerRole = null;
let currentRoom = null;

// –°–†–ê–ó–£ –ü–û–î–ö–õ–Æ–ß–ê–ï–ú–°–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
// –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL:
const SERVER_URL = "https://your-app-name.onrender.com"; 
socket = io(SERVER_URL);

socket.on('connect', () => {
    console.log("Connected to server!");
});

socket.on('onlineUpdate', (count) => {
    document.getElementById('online-counter').innerText = `–ò–ì–†–û–ö–û–í –í –°–ï–¢–ò: ${count}`;
});

socket.on('startGame', (data) => {
    playerRole = data.role;
    currentRoom = data.room;
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('game-container').style.display = 'block';
    setupCanvas();
    update();
});

socket.on('syncBuilding', (data) => {
    // –ó–µ—Ä–∫–∞–ª–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä–∞–≥–∞
    let rx = canvas.width - data.x - (data.type === 'wall' ? 80 : 40);
    let ry = canvas.height - data.y - (data.type === 'wall' ? 15 : 40);
    addBuilding(data.type, data.role, rx, ry);
});

function requestMatch() {
    socket.emit('findGame');
    document.getElementById('find-btn').disabled = true;
    document.getElementById('status-text').innerText = "–ü–û–ò–°–ö –ü–†–û–¢–ò–í–ù–ò–ö–ê...";
}

// --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê (–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –¥–ª—è —Ç–µ—Å—Ç–∞) ---
let gameState = { p1:{gold:100}, p2:{gold:100}, buildings:[], units:[] };

function setupCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

let dragging = null;
function startDrag(type, cost) {
    dragging = { type, cost };
}

window.addEventListener('touchend', (e) => {
    if (!dragging || !playerRole) return;
    let touch = e.changedTouches[0];
    let x = touch.clientX;
    let y = touch.clientY;

    if (y > canvas.height / 2 + 40) { // –ú–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ
        addBuilding(dragging.type, playerRole, x, y);
        socket.emit('placeBuilding', { type: dragging.type, x, y, role: playerRole, room: currentRoom });
    }
    dragging = null;
});

function addBuilding(type, player, x, y) {
    gameState.buildings.push({ type, player, x, y, lastSpawn: Date.now() });
}

function update() {
    // –ê–≤—Ç–æ-—Å–ø–∞–≤–Ω —é–Ω–∏—Ç–æ–≤
    gameState.buildings.forEach(b => {
        if ((b.type === 'barracks') && Date.now() - b.lastSpawn > 4000) {
            gameState.units.push({
                player: b.player,
                x: b.x,
                y: b.y,
                speed: b.player === playerRole ? -1 : 1
            });
            b.lastSpawn = Date.now();
        }
    });

    gameState.units.forEach((u, i) => {
        u.y += u.speed;
    });

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // –õ–∏–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞
    ctx.strokeStyle = "white";
    ctx.setLineDash([5, 15]);
    ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();
    ctx.setLineDash([]);

    gameState.buildings.forEach(b => {
        ctx.fillStyle = b.player === playerRole ? "blue" : "red";
        ctx.fillRect(b.x-20, b.y-20, 40, 40);
    });

    gameState.units.forEach(u => {
        ctx.fillStyle = u.player === playerRole ? "cyan" : "orange";
        ctx.beginPath(); ctx.arc(u.x, u.y, 8, 0, Math.PI*2); ctx.fill();
    });
}
</script>
</body>
</html>
