<!DOCTYPE html>
<html>
<head>
    <title>War Castle: Walls Tactical Update</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #game-container { width: 100vw; height: 100vh; overflow: hidden; position: relative; }
        canvas { display: block; background: #355e3b; touch-action: none; }

        #ui { position: fixed; bottom: 10px; left: 0; width: 100%; display: flex; justify-content: center; gap: 6px; z-index: 10; }
        .shop-item { 
            background: rgba(30, 30, 30, 0.95); border: 2px solid #4444ff; 
            width: 55px; height: 65px; text-align: center; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: 0.2s;
        }
        .shop-item.active { border-color: #ff00ff; background: rgba(80, 0, 80, 0.8); transform: scale(1.1); }
        .item-icon { font-size: 20px; }
        .item-cost { color: #ffd700; font-weight: bold; font-size: 10px; margin-top: 2px; }

        .stats { 
            position: fixed; top: 5px; width: 100%; display: flex; justify-content: space-between; 
            padding: 0 10px; box-sizing: border-box; z-index: 10; pointer-events: none;
        }
        .stat-card { background: rgba(0,0,0,0.7); padding: 6px 12px; border-radius: 8px; font-size: 11px; border-left: 4px solid #4444ff; backdrop-filter: blur(4px); }
        .red-side { border-left: 0; border-right: 4px solid #ff4444; text-align: right; }

        #drag-icon { position: fixed; width: 35px; height: 35px; background: rgba(0,0,255,0.3); border: 2px solid #fff; display: none; pointer-events: none; transform: translate(-50%, -50%); z-index: 100; font-size: 20px; text-align: center; line-height: 35px; }
        #drag-icon.wall-drag { width: 80px; height: 15px; }
    </style>
</head>
<body>

<div class="stats">
    <div class="stat-card">
        ğŸ’°<span id="gold1">0</span> | ğŸ° <span id="hp1">500</span><br>
        ğŸ’ <span id="mines1">0</span>/3 | âš”ï¸ <span id="bld1">0</span>/25
    </div>
    <div class="stat-card red-side">
        ğŸ° <span id="hp2">500</span> | ğŸ’°<span id="gold2">0</span><br>
        25/<span id="bld2">0</span> :âš”ï¸ | 3/<span id="mines2">0</span> :ğŸ’
    </div>
</div>

<div id="ui">
    <div class="shop-item" ontouchstart="startDrag('barracks', 50, event)">
        <div class="item-icon">ğŸ </div><div class="item-cost">50</div>
    </div>
    <div class="shop-item" ontouchstart="startDrag('archers', 150, event)">
        <div class="item-icon">ğŸ¹</div><div class="item-cost">150</div>
    </div>
    <div class="shop-item" ontouchstart="startDrag('wall', 200, event)">
        <div class="item-icon">ğŸ§±</div><div class="item-cost">200</div>
    </div>
    <div class="shop-item" ontouchstart="startDrag('turret', 70, event)">
        <div class="item-icon">ğŸ›¡ï¸</div><div class="item-cost">70</div>
    </div>
    <div class="shop-item" ontouchstart="startDrag('bomb', 200, event)">
        <div class="item-icon">ğŸ’£</div><div class="item-cost">200</div>
    </div>
    <div class="shop-item" ontouchstart="startDrag('mine', 100, event)">
        <div class="item-icon">ğŸ’</div><div class="item-cost" id="mine-cost-ui">100</div>
    </div>
    <div class="shop-item" id="sell-btn" onclick="toggleSellMode()">
        <div class="item-icon">ğŸ’°âœ–ï¸</div><div class="item-cost">Sell</div>
    </div>
</div>

<div id="drag-icon"></div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const dragIcon = document.getElementById("drag-icon");

let sellMode = false;
let gameActive = true;
let gameState = {
    p1: { gold: 100, hp: 500, income: 3, mines: 0, combatBuildings: 0, barracks: 0, archerHouses: 0, turrets: 0, bombs: 0 }, 
    p2: { gold: 100, hp: 500, income: 3, mines: 0, combatBuildings: 0, barracks: 0, archerHouses: 0, turrets: 0, bombs: 0 }, 
    units: [], buildings: [], projectiles: [], vfx: []
};

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ° Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¹
canvas.addEventListener('mousedown', (e) => {
    if (!sellMode) return;
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;

    const bIndex = gameState.buildings.findIndex(b => {
        let bw = b.type === 'wall' ? 80 : 40;
        let bh = b.type === 'wall' ? 15 : 40;
        return b.player === 1 && clickX > b.x && clickX < b.x + bw && clickY > b.y && clickY < b.y + bh;
    });

    if (bIndex !== -1) {
        let b = gameState.buildings[bIndex];
        let refund = b.type === 'mine' ? getMineCost(gameState.p1.mines - 1) / 2 : 25;
        gameState.p1.gold += refund;
        destroyBuilding(bIndex);
    }
});

function toggleSellMode() {
    sellMode = !sellMode;
    document.getElementById('sell-btn').classList.toggle('active', sellMode);
}

function destroyBuilding(index) {
    let b = gameState.buildings[index];
    let p = b.player === 1 ? gameState.p1 : gameState.p2;
    if (b.type === 'mine') { p.income -= 4; p.mines--; }
    else { 
        if (b.type === 'bomb') p.bombs--; 
        else if (b.type === 'barracks') p.barracks--;
        else if (b.type === 'archers') p.archerHouses--;
        else if (b.type !== 'wall') p.turrets--;
        p.combatBuildings--; 
    }
    gameState.buildings.splice(index, 1);
}

function getMineCost(mines) { return 100 + (mines * 100); }

let dragging = null;
function startDrag(type, cost, e) {
    if (e) e.preventDefault();
    sellMode = false;
    document.getElementById('sell-btn').classList.remove('active');
    
    let actualCost = type === 'mine' ? getMineCost(gameState.p1.mines) : cost;
    if (gameState.p1.gold >= actualCost) {
        if (type === 'mine' && gameState.p1.mines >= 3) return;
        if (type !== 'mine' && gameState.p1.combatBuildings >= 25) return;
        
        dragging = { type, cost: actualCost };
        dragIcon.style.display = "block";
        dragIcon.innerHTML = (type === 'wall') ? "" : "ğŸ "; // Ğ£Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ» Ğ¸ĞºĞ¾Ğ½ĞºÑƒ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°
        if (type === 'wall') dragIcon.classList.add('wall-drag');
        else dragIcon.classList.remove('wall-drag');
    }
}

window.addEventListener('touchmove', (e) => {
    if (!dragging) return;
    dragIcon.style.left = e.touches[0].clientX + "px";
    dragIcon.style.top = e.touches[0].clientY + "px";
}, { passive: false });

window.addEventListener('touchend', (e) => {
    if (!dragging) return;
    let touch = e.changedTouches[0];
    let cX = touch.clientX, cY = touch.clientY;
    
    let w = dragging.type === 'wall' ? 80 : 40;
    let h = dragging.type === 'wall' ? 15 : 40;

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ¾Ğ½Ñ‹ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ¸ Ğ·Ğ°Ğ½ÑÑ‚Ğ¾ÑÑ‚Ğ¸ Ğ¼ĞµÑÑ‚Ğ°
    let isOccupied = gameState.buildings.some(b => {
        let bw = b.type === 'wall' ? 80 : 40;
        let bh = b.type === 'wall' ? 15 : 40;
        return !(cX-w/2 + w < b.x || cX-w/2 > b.x + bw || cY-h/2 + h < b.y || cY-h/2 > b.y + bh);
    });

    if (cY > canvas.height / 2 && cY < canvas.height - 80 && !isOccupied) {
        gameState.p1.gold -= dragging.cost;
        if (dragging.type === 'mine') { gameState.p1.income += 4; gameState.p1.mines++; }
        else { 
            if (dragging.type === 'bomb') gameState.p1.bombs++;
            else if (dragging.type === 'barracks') gameState.p1.barracks++;
            else if (dragging.type === 'archers') gameState.p1.archerHouses++;
            else if (dragging.type !== 'wall') gameState.p1.turrets++;
            gameState.p1.combatBuildings++; 
        }
        let hp = (dragging.type === 'wall') ? 900 : 350;
        gameState.buildings.push({ type: dragging.type, player: 1, x: cX - w/2, y: cY - h/2, hp: hp, maxHp: hp, lastSpawn: 0, lastShot: 0 });
    }
    dragging = null;
    dragIcon.style.display = "none";
});

// ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ˜Ğ˜
setInterval(() => {
    if (!gameActive) return;
    let p2 = gameState.p2;
    if (p2.gold >= 50 && p2.combatBuildings < 25) {
        let x = Math.random() * (canvas.width - 50);
        let y = 100 + Math.random() * (canvas.height / 2 - 150);
        gameState.buildings.push({ type: 'barracks', player: 2, x, y, hp: 350, maxHp: 350, lastSpawn: Date.now() });
        p2.gold -= 50; p2.combatBuildings++;
    }
}, 3000);

function update() {
    if (!gameActive) return;

    gameState.p1.gold += gameState.p1.income / 60;
    gameState.p2.gold += gameState.p2.income / 60;

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ UI
    document.getElementById("gold1").innerText = Math.floor(gameState.p1.gold);
    document.getElementById("gold2").innerText = Math.floor(gameState.p2.gold);
    document.getElementById("hp1").innerText = Math.floor(gameState.p1.hp);
    document.getElementById("hp2").innerText = Math.floor(gameState.p2.hp);

    gameState.buildings.forEach((b, bi) => {
        // Ğ¡Ğ¿Ğ°Ğ²Ğ½ ÑĞ½Ğ¸Ñ‚Ğ¾Ğ²
        if ((b.type === 'barracks' || b.type === 'archers') && Date.now() - b.lastSpawn > 5000) {
            gameState.units.push({ 
                player: b.player, 
                type: b.type === 'archers' ? 'archer' : 'knight', 
                x: b.x + 20, y: b.y + 20, 
                hp: 100, maxHp: 100, 
                speed: b.player === 1 ? -1 : 1, 
                lastShot: 0 
            });
            b.lastSpawn = Date.now();
        }
        if (b.hp <= 0) destroyBuilding(bi);
    });

    gameState.units.forEach((u, i) => {
        // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸ Ğ°Ñ‚Ğ°ĞºĞ¸
        let target = gameState.buildings.find(b => b.player !== u.player && Math.hypot(b.x - u.x, b.y - u.y) < 50);
        if (target) {
            target.hp -= 0.5;
        } else {
            u.y += u.speed;
        }

        // Ğ£Ñ€Ğ¾Ğ½ Ğ±Ğ°Ğ·Ğµ
        if (u.y < 0) { gameState.p2.hp -= 50; gameState.units.splice(i, 1); }
        else if (u.y > canvas.height) { gameState.p1.hp -= 50; gameState.units.splice(i, 1); }
    });

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ†Ğ° Ğ¸Ğ³Ñ€Ñ‹
    if (gameState.p1.hp <= 0 || gameState.p2.hp <= 0) {
        gameActive = false;
        alert(gameState.p1.hp <= 0 ? "Ğ’Ğ ĞĞ“ ĞŸĞĞ‘Ğ•Ğ”Ğ˜Ğ›!" : "Ğ’Ğ« ĞŸĞĞ‘Ğ•Ğ”Ğ˜Ğ›Ğ˜!");
        location.reload();
    }

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Ğ¡ĞµÑ‚ĞºĞ°/ĞŸĞ¾Ğ»Ğµ
    ctx.strokeStyle = "rgba(255,255,255,0.1)";
    ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();

    gameState.buildings.forEach(b => {
        ctx.fillStyle = b.player === 1 ? "#3b44cc" : "#cc3b3b";
        let w = b.type === 'wall' ? 80 : 40;
        let h = b.type === 'wall' ? 15 : 40;
        ctx.fillRect(b.x, b.y, w, h);
        // HP Bar
        ctx.fillStyle = "black"; ctx.fillRect(b.x, b.y - 10, w, 5);
        ctx.fillStyle = "green"; ctx.fillRect(b.x, b.y - 10, (b.hp/b.maxHp) * w, 5);
    });

    gameState.units.forEach(u => {
        ctx.fillStyle = u.player === 1 ? "blue" : "red";
        ctx.beginPath(); ctx.arc(u.x, u.y, 10, 0, Math.PI*2); ctx.fill();
    });
}

update();
</script>
</body>
</html>
