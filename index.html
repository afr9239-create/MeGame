<!DOCTYPE html>
<html>
<head>
    <title>War Castle: Arena Shooter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        canvas { display: block; }

        #ui-container {
            position: fixed; top: 10px; left: 10px; color: white; 
            text-shadow: 2px 2px 2px rgba(0,0,0,0.8); pointer-events: none; z-index: 10;
        }
        .info-box { background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 20px; margin-bottom: 5px; border: 1px solid rgba(255,255,255,0.2); }

        #minimap {
            position: fixed; top: 10px; right: 10px; width: 120px; height: 120px;
            background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.5); border-radius: 50%;
        }

        #joystick-ui {
            position: fixed; bottom: 40px; left: 40px; width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.2);
        }
        #knob {
            position: absolute; top: 35px; left: 35px; width: 50px; height: 50px;
            background: white; border-radius: 50%; box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        #attack-btn {
            position: fixed; bottom: 50px; right: 50px; width: 110px; height: 110px;
            background: radial-gradient(circle, #ff4444, #990000); border: 4px solid white; border-radius: 50%;
            color: white; font-weight: bold; display: flex; align-items: center; justify-content: center;
            user-select: none; -webkit-user-select: none; box-shadow: 0 0 20px rgba(255,0,0,0.4);
            active { transform: scale(0.9); }
        }
    </style>
</head>
<body>

<div id="ui-container">
    <div class="info-box">Бойцов в сети: <span id="p-count">0</span></div>
</div>

<canvas id="minimap"></canvas>
<div id="joystick-ui"><div id="knob"></div></div>
<div id="attack-btn">ОГОНЬ</div>
<canvas id="gameCanvas"></canvas>

<script>
const socket = io("https://war-castle.onrender.com"); 

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const mCanvas = document.getElementById("minimap");
const mCtx = mCanvas.getContext("2d");

// Настройки мира
const WORLD_RADIUS = 1000; // Размер круглой карты
let players = {};
let bullets = [];
let camX = 0, camY = 0;

let myPos = { 
    id: null,
    x: 0, 
    y: 0, 
    color: `hsl(${Math.random()*360}, 70%, 60%)`, 
    angle: 0, 
    hp: 100,
    isFiring: false
};

myPos.id = Math.random().toString(36).substr(2, 9);

// Полноэкранный режим при первом взаимодействии
document.addEventListener('click', () => {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(e => console.log(e));
    }
}, { once: true });

let moveDir = { x: 0, y: 0 };
const speed = 6;

// Управление стрельбой
const atkBtn = document.getElementById("attack-btn");
atkBtn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    fireBullet();
});

function fireBullet() {
    const bullet = {
        id: Math.random(),
        owner: socket.id,
        x: myPos.x + Math.cos(myPos.angle) * 40,
        y: myPos.y + Math.sin(myPos.angle) * 40,
        vx: Math.cos(myPos.angle) * 15,
        vy: Math.sin(myPos.angle) * 15,
        life: 100
    };
    bullets.push(bullet);
    socket.emit('shoot', bullet); // Отправляем пулю на сервер
}

// Джойстик
let joyTouchId = null;
const joy = document.getElementById("joystick-ui");
const knob = document.getElementById("knob");

window.addEventListener('touchstart', (e) => {
    for(let t of e.changedTouches) {
        let r = joy.getBoundingClientRect();
        if(t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) {
            joyTouchId = t.identifier;
        }
    }
});

window.addEventListener('touchmove', (e) => {
    for(let t of e.touches) {
        if(t.identifier === joyTouchId) {
            let r = joy.getBoundingClientRect();
            let dx = t.clientX - (r.left + r.width/2);
            let dy = t.clientY - (r.top + r.height/2);
            let dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 45) { dx *= 45/dist; dy *= 45/dist; }
            knob.style.transform = `translate(${dx}px, ${dy}px)`;
            moveDir = { x: dx/45, y: dy/45 };
            myPos.angle = Math.atan2(dy, dx);
        }
    }
}, {passive: false});

window.addEventListener('touchend', (e) => {
    for(let t of e.changedTouches) {
        if(t.identifier === joyTouchId) {
            joyTouchId = null;
            knob.style.transform = `translate(0,0)`;
            moveDir = { x: 0, y: 0 };
        }
    }
});

socket.on('update', (serverPlayers) => {
    players = serverPlayers;
    if(players[socket.id]) myPos.hp = players[socket.id].hp;
    document.getElementById('p-count').innerText = Object.keys(players).length;
});

// Получение пуль от других игроков
socket.on('bulletUpdate', (newBullet) => {
    if(newBullet.owner !== socket.id) bullets.push(newBullet);
});

function update() {
    // Движение
    let nextX = myPos.x + moveDir.x * speed;
    let nextY = myPos.y + moveDir.y * speed;

    // Проверка границ круглой карты
    let distFromCenter = Math.sqrt(nextX*nextX + nextY*nextY);
    if(distFromCenter < WORLD_RADIUS - 30) {
        myPos.x = nextX;
        myPos.y = nextY;
    }

    // Плавная камера (Lerp)
    camX += (myPos.x - camX) * 0.1;
    camY += (myPos.y - camY) * 0.1;

    // Обновление пуль
    for(let i = bullets.length - 1; i >= 0; i--) {
        let b = bullets[i];
        b.x += b.vx;
        b.y += b.vy;
        b.life--;

        // Проверка попадания в нас (упрощенно локально)
        if(b.owner !== socket.id) {
            let dx = b.x - myPos.x;
            let dy = b.y - myPos.y;
            if(Math.sqrt(dx*dx + dy*dy) < 40) {
                myPos.hp -= 5;
                bullets.splice(i, 1);
                socket.emit('hit', { targetId: socket.id, damage: 5 });
                continue;
            }
        }

        if(b.life <= 0) bullets.splice(i, 1);
    }

    socket.emit('move', myPos);
    draw();
    requestAnimationFrame(update);
}

function draw() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // Фон
    ctx.fillStyle = "#1a1a1a";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(canvas.width/2 - camX, canvas.height/2 - camY);

    // Рисуем круглую арену
    ctx.beginPath();
    ctx.arc(0, 0, WORLD_RADIUS, 0, Math.PI*2);
    ctx.fillStyle = "#2d4c2d";
    ctx.fill();
    ctx.strokeStyle = "#4a7a4a";
    ctx.lineWidth = 10;
    ctx.stroke();

    // Сетка для ощущения движения
    ctx.strokeStyle = "rgba(255,255,255,0.05)";
    ctx.lineWidth = 2;
    for(let i = -WORLD_RADIUS; i < WORLD_RADIUS; i+=100) {
        ctx.beginPath(); ctx.moveTo(i, -WORLD_RADIUS); ctx.lineTo(i, WORLD_RADIUS); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(-WORLD_RADIUS, i); ctx.lineTo(WORLD_RADIUS, i); ctx.stroke();
    }

    // Пули
    bullets.forEach(b => {
        ctx.fillStyle = "#fff700";
        ctx.beginPath();
        ctx.arc(b.x, b.y, 5, 0, Math.PI*2);
        ctx.fill();
    });

    // Игроки
    for(let id in players) {
        drawPlayer(players[id], id === socket.id);
    }

    ctx.restore();
    drawMinimap();
}

function drawPlayer(p, isMe) {
    ctx.save();
    ctx.translate(p.x, p.y);
    
    // Полоска ХП
    ctx.fillStyle = "rgba(0,0,0,0.5)";
    ctx.fillRect(-40, -60, 80, 8);
    ctx.fillStyle = p.hp > 30 ? "#00ff00" : "#ff0000";
    ctx.fillRect(-40, -60, (p.hp/100)*80, 8);

    ctx.rotate(p.angle);

    // Рисуем пистолет
    ctx.fillStyle = "#333";
    ctx.fillRect(25, 15, 30, 12); // Ствол
    ctx.strokeStyle = "black";
    ctx.lineWidth = 2;
    ctx.strokeRect(25, 15, 30, 12);

    // Тело игрока
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(0, 0, 35, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = isMe ? "white" : "black";
    ctx.lineWidth = 3;
    ctx.stroke();

    // Глаза (чтобы видеть направление)
    ctx.fillStyle = "white";
    ctx.beginPath(); ctx.arc(15, -12, 6, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(15, 12, 6, 0, Math.PI*2); ctx.fill();

    ctx.restore();
}

function drawMinimap() {
    mCanvas.width = 120; mCanvas.height = 120;
    mCtx.clearRect(0,0,120,120);
    
    // Игроки на миникарте
    for(let id in players) {
        let p = players[id];
        let mx = (p.x / (WORLD_RADIUS*2)) * 120 + 60;
        let my = (p.y / (WORLD_RADIUS*2)) * 120 + 60;
        mCtx.fillStyle = (id === socket.id) ? "#fff" : "#f00";
        mCtx.beginPath(); mCtx.arc(mx, my, 4, 0, Math.PI*2); mCtx.fill();
    }
}

update();
</script>
</body>
</html>
