<!DOCTYPE html>
<html>
<head>
    <title>War Castle: Open World RPG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #222; overflow: hidden; font-family: sans-serif; touch-action: none; }
        canvas { display: block; }

        /* Стили джойстика */
        #joystick-container {
            position: fixed; bottom: 40px; left: 40px;
            width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.3);
            touch-action: none; z-index: 100;
        }
        #joystick-knob {
            position: absolute; top: 35px; left: 35px;
            width: 50px; height: 50px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        #ui-overlay {
            position: fixed; top: 10px; left: 10px;
            color: white; pointer-events: none; z-index: 10;
            text-shadow: 1px 1px 2px #000;
        }
    </style>
</head>
<body>

<div id="ui-overlay">
    <div>Мир: <span id="coords">0, 0</span></div>
    <div id="player-count">Игроков в сети: 1</div>
</div>

<div id="joystick-container">
    <div id="joystick-knob"></div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const socket = io("https://war-castle.onrender.com"); // Твой сервер на Render
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// Параметры игрока
let myId = null;
const players = {}; 
let myPos = { x: 0, y: 0, color: '#' + Math.floor(Math.random()*16777215).toString(16) };
let moveDir = { x: 0, y: 0 };
const speed = 5;

// Джойстик
const joystick = document.getElementById("joystick-container");
const knob = document.getElementById("joystick-knob");
let joystickActive = false;

// --- СЕТЕВАЯ ЛОГИКА ---
socket.on('connect', () => {
    myId = socket.id;
    socket.emit('initPlayer', { x: 0, y: 0, color: myPos.color });
});

socket.on('updatePlayers', (serverPlayers) => {
    // Обновляем список всех игроков
    for (let id in serverPlayers) {
        players[id] = serverPlayers[id];
    }
    // Удаляем ушедших
    for (let id in players) {
        if (!serverPlayers[id]) delete players[id];
    }
    document.getElementById('player-count').innerText = `Игроков в сети: ${Object.keys(players).length}`;
});

// --- УПРАВЛЕНИЕ (ДЖОЙСТИК) ---
joystick.addEventListener('touchstart', (e) => { joystickActive = true; moveJoystick(e); });
window.addEventListener('touchmove', (e) => { if(joystickActive) moveJoystick(e); });
window.addEventListener('touchend', () => {
    joystickActive = false;
    knob.style.transform = `translate(0px, 0px)`;
    moveDir = { x: 0, y: 0 };
});

function moveJoystick(e) {
    const touch = e.touches[0];
    const rect = joystick.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    let dx = touch.clientX - centerX;
    let dy = touch.clientY - centerY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const maxDist = 40;

    if (dist > maxDist) {
        dx *= maxDist / dist;
        dy *= maxDist / dist;
    }

    knob.style.transform = `translate(${dx}px, ${dy}px)`;
    
    // Направление движения
    moveDir.x = dx / maxDist;
    moveDir.y = dy / maxDist;
}

// --- ЦИКЛ ИГРЫ ---
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.onresize = resize;
resize();

function update() {
    if (moveDir.x !== 0 || moveDir.y !== 0) {
        myPos.x += moveDir.x * speed;
        myPos.y += moveDir.y * speed;
        
        // Отправляем свои координаты на сервер
        socket.emit('move', { x: myPos.x, y: myPos.y });
        document.getElementById('coords').innerText = `${Math.floor(myPos.x)}, ${Math.floor(myPos.y)}`;
    }
    
    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;

    // РИСУЕМ СЕТКУ (фон движется относительно игрока)
    ctx.strokeStyle = "#333";
    ctx.lineWidth = 1;
    const gridSize = 100;
    const offsetX = -myPos.x % gridSize;
    const offsetY = -myPos.y % gridSize;

    for (let x = offsetX; x < canvas.width; x += gridSize) {
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
    }
    for (let y = offsetY; y < canvas.height; y += gridSize) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
    }

    // РИСУЕМ ДРУГИХ ИГРОКОВ
    for (let id in players) {
        if (id === myId) continue;
        const p = players[id];
        // Позиция игрока относительно меня
        const relX = centerX + (p.x - myPos.x);
        const relY = centerY + (p.y - myPos.y);
        
        drawPlayer(relX, relY, p.color, false);
    }

    // РИСУЕМ СЕБЯ (всегда в центре)
    drawPlayer(centerX, centerY, myPos.color, true);
}

function drawPlayer(x, y, color, isMe) {
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x, y, 25, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = "white";
    ctx.lineWidth = isMe ? 4 : 2;
    ctx.stroke();
    
    if (isMe) {
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.fillText("ВЫ", x, y - 35);
    }
}

update();
</script>
</body>
</html>
