<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>War Castle Multiplayer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        
        /* –ú–µ–Ω—é */
        #lobby { position: fixed; inset: 0; background: #111; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #online-counter { color: #00ff00; margin: 15px; font-weight: bold; }
        
        /* –ò–≥—Ä–∞ */
        #game-container { display: none; width: 100vw; height: 100vh; position: relative; }
        canvas { display: block; background: #355e3b; }

        .stats { position: fixed; top: 10px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; font-size: 20px; font-weight: bold; pointer-events: none; }
        
        #ui { position: fixed; bottom: 15px; width: 100%; display: flex; justify-content: center; gap: 10px; }
        .shop-item { background: rgba(0,0,0,0.8); border: 2px solid #4444ff; padding: 10px; border-radius: 10px; text-align: center; width: 70px; cursor: pointer; }
        .shop-item.active { border-color: #00ff00; background: #333; }

        button { padding: 15px 40px; font-size: 22px; background: #4444ff; color: white; border: none; border-radius: 12px; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: default; }
    </style>
</head>
<body>

<div id="lobby">
    <h1 style="color: #4444ff; letter-spacing: 5px;">WAR CASTLE</h1>
    <div id="online-counter">–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ú–û–ó–ì–£...</div>
    <button id="find-btn" onclick="requestMatch()">–í –ë–û–ô!</button>
</div>

<div id="game-container">
    <div class="stats">
        <div style="color: gold;">üí∞ <span id="gold-ui">100</span></div>
        <div style="color: #ff4444;">‚ù§ –í–†–ê–ì: <span id="hp-ui">1000</span></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui">
        <div class="shop-item" id="btn-barracks" onclick="selectBuilding('barracks', 50)">üè†<br>50</div>
        <div class="shop-item" id="btn-mine" onclick="selectBuilding('mine', 100)">üíé<br>100</div>
    </div>
</div>

<script>
    // –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –¢–í–û–ï–ú–£ –°–ï–†–í–ï–†–£
    const socket = io("https://war-castle-v2.onrender.com");
    
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    
    let role = null;
    let room = null;
    let gold = 100;
    let minesCount = 0;
    let enemyBaseHp = 1000;
    let selectedType = null;
    let selectedCost = 0;

    let state = { buildings: [], units: [] };

    // --- –°–ï–¢–¨ ---
    socket.on('onlineUpdate', (count) => {
        document.getElementById('online-counter').innerText = `–ò–ì–†–û–ö–û–í –í –°–ï–¢–ò: ${count}`;
    });

    socket.on('startGame', (data) => {
        role = data.role;
        room = data.room;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        resize();
        requestAnimationFrame(gameLoop);
    });

    socket.on('syncBuilding', (data) => {
        // –ó–µ—Ä–∫–∞–ª–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –≤—Ä–∞–≥–∞ (–∏–Ω–≤–µ—Ä—Å–∏—è X –∏ Y)
        const rx = canvas.width - data.x;
        const ry = canvas.height - data.y;
        addBuilding(data.type, data.role, rx, ry);
    });

    function requestMatch() {
        socket.emit('findGame');
        document.getElementById('find-btn').disabled = true;
        document.getElementById('find-btn').innerText = "–ü–û–ò–°–ö –í–†–ê–ì–ê...";
    }

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    function selectBuilding(type, cost) {
        selectedType = type;
        selectedCost = cost;
        document.querySelectorAll('.shop-item').forEach(el => el.classList.remove('active'));
        document.getElementById('btn-' + type).classList.add('active');
    }

    canvas.onclick = (e) => {
        if (!selectedType || gold < selectedCost) return;
        
        // –ú–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–≤–æ–µ–π –Ω–∏–∂–Ω–µ–π –ø–æ–ª–æ–≤–∏–Ω–µ
        if (e.clientY > canvas.height / 2 + 50) {
            gold -= selectedCost;
            addBuilding(selectedType, role, e.clientX, e.clientY);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Ä–∞–≥—É
            socket.emit('placeBuilding', {
                type: selectedType,
                x: e.clientX,
                y: e.clientY,
                role: role,
                room: room
            });

            selectedType = null;
            document.querySelectorAll('.shop-item').forEach(el => el.classList.remove('active'));
        }
    };

    function addBuilding(type, bRole, x, y) {
        state.buildings.push({
            type,
            role: bRole,
            x,
            y,
            lastSpawn: Date.now()
        });
        if (type === 'mine' && bRole === role) minesCount++;
    }

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –õ–∏–Ω–∏—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
        ctx.strokeStyle = "rgba(255,255,255,0.2)";
        ctx.setLineDash([10, 10]);
        ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();
        ctx.setLineDash([]);

        // –ó–æ–ª–æ—Ç–æ
        gold += (1 + minesCount * 2) / 60;
        document.getElementById('gold-ui').innerText = Math.floor(gold);

        // –ó–¥–∞–Ω–∏—è
        state.buildings.forEach(b => {
            ctx.fillStyle = b.role === role ? "#4444ff" : "#ff4444";
            const size = b.type === 'mine' ? 30 : 40;
            ctx.fillRect(b.x - size/2, b.y - size/2, size, size);

            // –°–ø–∞–≤–Ω —Ä—ã—Ü–∞—Ä–µ–π –∏–∑ –±–∞–∑
            if (b.type === 'barracks' && Date.now() - b.lastSpawn > 4000) {
                state.units.push({
                    x: b.x,
                    y: b.y,
                    role: b.role,
                    speed: b.role === role ? -1.5 : 1.5
                });
                b.lastSpawn = Date.now();
            }
        });

        // –Æ–Ω–∏—Ç—ã
        state.units.forEach((u, i) => {
            u.y += u.speed;
            ctx.fillStyle = u.role === role ? "#00ffff" : "#ffaa00";
            ctx.beginPath();
            ctx.arc(u.x, u.y, 8, 0, Math.PI*2);
            ctx.fill();

            // –ï—Å–ª–∏ —é–Ω–∏—Ç –¥–æ—à–µ–ª –¥–æ –∫—Ä–∞—è - —É—Ä–æ–Ω –±–∞–∑–µ
            if (u.y < 0 || u.y > canvas.height) {
                if (u.role === role) enemyBaseHp -= 50;
                state.units.splice(i, 1);
                document.getElementById('hp-ui').innerText = enemyBaseHp;
                if (enemyBaseHp <= 0) alert("–ö–û–ù–ï–¶ –ò–ì–†–´!");
            }
        });

        requestAnimationFrame(gameLoop);
    }

    window.onresize = resize;
</script>
</body>
</html>
